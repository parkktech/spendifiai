---
phase: 05-testing-deployment
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - tests/Feature/Auth/ApiAuthTest.php
  - tests/Feature/Plaid/PlaidFlowTest.php
  - tests/Feature/Transaction/TransactionTest.php
  - tests/Feature/AIQuestion/AIQuestionTest.php
  - tests/Feature/Subscription/SubscriptionTest.php
  - tests/Feature/Savings/SavingsTest.php
  - tests/Feature/Tax/TaxTest.php
  - tests/Feature/Account/AccountDeletionTest.php
  - tests/Unit/Services/TransactionCategorizerServiceTest.php
  - tests/Unit/Services/SubscriptionDetectorServiceTest.php
  - tests/Unit/Services/TaxExportServiceTest.php
  - tests/Unit/Services/CaptchaServiceTest.php
autonomous: true

must_haves:
  truths:
    - "Auth flow tests verify register, login, logout, 2FA prompt, and lockout"
    - "Plaid flow tests verify link token creation, token exchange, sync, and disconnect with Http::fake"
    - "Transaction tests verify listing with filters and category update"
    - "AI question tests verify listing, individual answer, and bulk answer"
    - "Subscription tests verify listing and detection"
    - "Savings tests verify recommendations listing, target creation, and action response"
    - "Tax test verifies summary endpoint returns grouped deductible totals"
    - "Account deletion test verifies cascading data removal"
    - "Unit tests verify TransactionCategorizerService confidence routing at all 4 thresholds"
    - "Unit tests verify SubscriptionDetectorService recurrence detection for monthly, weekly, and null patterns"
    - "Unit tests verify TaxExportService Schedule C line mapping"
    - "Unit tests verify CaptchaService score thresholds and disabled config"
  artifacts:
    - path: "tests/Feature/Auth/ApiAuthTest.php"
      provides: "API auth flow tests"
      contains: "api/auth/register"
    - path: "tests/Feature/Plaid/PlaidFlowTest.php"
      provides: "Plaid integration tests with Http::fake"
      contains: "Http::fake"
    - path: "tests/Feature/Transaction/TransactionTest.php"
      provides: "Transaction listing and category update tests"
      contains: "api/v1/transactions"
    - path: "tests/Unit/Services/TransactionCategorizerServiceTest.php"
      provides: "Categorizer confidence routing tests"
      contains: "CONFIDENCE_AUTO"
    - path: "tests/Unit/Services/CaptchaServiceTest.php"
      provides: "Captcha score threshold tests"
      contains: "CaptchaService"
  key_links:
    - from: "tests/Feature/Plaid/PlaidFlowTest.php"
      to: "app/Http/Controllers/Api/PlaidController.php"
      via: "HTTP test assertions"
      pattern: "postJson.*plaid"
    - from: "tests/Unit/Services/TransactionCategorizerServiceTest.php"
      to: "app/Services/AI/TransactionCategorizerService.php"
      via: "Direct service instantiation with Http::fake"
      pattern: "TransactionCategorizerService"
---

<objective>
Write all feature tests (8 test files covering auth, Plaid, transactions, AI questions, subscriptions, savings, tax, and account deletion) and all unit tests (4 test files covering TransactionCategorizerService, SubscriptionDetectorService, TaxExportService, and CaptchaService).

Purpose: Ensure all critical user flows and business logic are covered by automated tests that verify correct behavior. This covers requirements TEST-02 through TEST-13.
Output: 8 feature test files in tests/Feature/ and 4 unit test files in tests/Unit/Services/.
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-testing-deployment/05-RESEARCH.md
@.planning/phases/05-testing-deployment/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write all 8 feature test files</name>
  <files>
    tests/Feature/Auth/ApiAuthTest.php,
    tests/Feature/Plaid/PlaidFlowTest.php,
    tests/Feature/Transaction/TransactionTest.php,
    tests/Feature/AIQuestion/AIQuestionTest.php,
    tests/Feature/Subscription/SubscriptionTest.php,
    tests/Feature/Savings/SavingsTest.php,
    tests/Feature/Tax/TaxTest.php,
    tests/Feature/Account/AccountDeletionTest.php
  </files>
  <action>
Create 8 Pest PHP test files. Use `Sanctum::actingAs()` for auth. Use the Pest.php helpers `createAuthenticatedUser()`, `createUserWithBank()`, `createUserWithBankAndProfile()` from Plan 05-01. Use `Http::fake()` for ALL external API calls (Plaid, Anthropic, reCAPTCHA). Keep existing Breeze auth tests untouched -- these new tests target API routes, not web routes.

IMPORTANT patterns for all feature tests:
- All tests in tests/Feature/ automatically get RefreshDatabase via Pest.php config
- Use `Sanctum::actingAs($user)` for API auth (NOT `$this->actingAs()`)
- Routes behind `bank.connected` middleware REQUIRE an active BankConnection -- use `createUserWithBank()`
- Routes behind `profile.complete` middleware REQUIRE UserFinancialProfile with employment_type -- use `createUserWithBankAndProfile()`
- Disable captcha in auth tests: `config(['spendwise.captcha.enabled' => false])` at start of test

**File 1: tests/Feature/Auth/ApiAuthTest.php** (TEST-02)
Tests:
- `can register via API` -- POST /api/auth/register with name, email, password, password_confirmation. Assert 201, response has 'token' and 'user' keys. Disable captcha first.
- `can login via API` -- Create user first, POST /api/auth/login with email, password. Assert 200, response has 'token'. Disable captcha.
- `login fails with wrong password` -- POST /api/auth/login with wrong password. Assert 401 or 422.
- `can logout via API` -- Create authenticated user, POST /api/auth/logout. Assert 200. Subsequent GET /api/auth/me returns 401.
- `can get current user` -- Create authenticated user, GET /api/auth/me. Assert 200, response has user email.
- `login prompts for 2FA when enabled` -- Create user with withTwoFactor() state. POST /api/auth/login. Assert response indicates 2FA required (check for 'two_factor' key or specific status code).
- `unauthenticated request returns 401` -- GET /api/auth/me without auth. Assert 401.

**File 2: tests/Feature/Plaid/PlaidFlowTest.php** (TEST-03)
Tests (ALL use Http::fake for Plaid API):
- `can create link token` -- Http::fake the /link/token/create response. POST /api/v1/plaid/link-token. Assert 200, response has 'link_token'.
- `can exchange public token and connect bank` -- Http::fake the token exchange, item/get, institutions/get_by_id, and accounts/get Plaid endpoints. POST /api/v1/plaid/exchange with public_token. Assert 200, BankConnection created in DB, BankAccounts created.
- `can sync transactions` -- Create user with bank. Http::fake the /transactions/sync Plaid endpoint returning sample transactions. POST /api/v1/plaid/sync. Assert 200, transactions exist in DB.
- `can disconnect bank` -- Create user with bank connection. Http::fake the /item/remove Plaid endpoint. DELETE /api/v1/plaid/{connection}. Assert 200, connection status is disconnected or deleted.

Http::fake URL patterns to use:
```php
Http::fake([
    'sandbox.plaid.com/link/token/create' => Http::response(['link_token' => 'link-sandbox-test', 'expiration' => '2026-12-31T00:00:00Z']),
    'sandbox.plaid.com/item/public_token/exchange' => Http::response(['access_token' => 'access-sandbox-test', 'item_id' => 'item-sandbox-test']),
    'sandbox.plaid.com/item/get' => Http::response(['item' => ['institution_id' => 'ins_109508']]),
    'sandbox.plaid.com/institutions/get_by_id' => Http::response(['institution' => ['name' => 'Chase', 'institution_id' => 'ins_109508']]),
    'sandbox.plaid.com/accounts/get' => Http::response(['accounts' => [['account_id' => 'acc_test_123', 'name' => 'Checking', 'type' => 'depository', 'subtype' => 'checking', 'mask' => '1234', 'balances' => ['current' => 1000.00, 'available' => 900.00]]]]),
    'sandbox.plaid.com/transactions/sync' => Http::response(['added' => [['transaction_id' => 'txn_test_1', 'account_id' => 'acc_test_123', 'name' => 'WHOLE FOODS', 'amount' => 85.47, 'date' => '2026-01-15', 'payment_channel' => 'in store', 'personal_finance_category' => ['primary' => 'FOOD_AND_DRINK']]], 'modified' => [], 'removed' => [], 'next_cursor' => 'cursor_123', 'has_more' => false]),
    'sandbox.plaid.com/item/remove' => Http::response(['request_id' => 'req_test']),
]);
```
Also fake the Anthropic API URL (categorization is dispatched as a job after exchange -- use Queue::fake() or Http::fake the anthropic endpoint).

**File 3: tests/Feature/Transaction/TransactionTest.php** (TEST-04)
Tests:
- `can list transactions` -- createUserWithBank(), create 5 Transaction records via factory. GET /api/v1/transactions. Assert 200, response has 'data' with items.
- `can filter transactions by account_purpose` -- Create business and personal transactions. GET /api/v1/transactions?purpose=business. Assert only business transactions returned.
- `can filter transactions by date range` -- Create transactions across dates. GET /api/v1/transactions?from=2026-01-01&to=2026-01-31. Assert filtered.
- `can update transaction category` -- Create a transaction. PATCH /api/v1/transactions/{id}/category with {user_category: 'Office Supplies'}. Assert 200, transaction review_status updated to 'user_confirmed'.
- `cannot access other users transactions` -- Create two users. User A creates transactions. User B tries to update User A's transaction. Assert 403.

**File 4: tests/Feature/AIQuestion/AIQuestionTest.php** (TEST-05)
Tests:
- `can list pending questions` -- createUserWithBank(), create AIQuestion records via factory with pending status. GET /api/v1/questions. Assert 200, returns questions.
- `can answer a question` -- Create a pending question. POST /api/v1/questions/{id}/answer with {answer: 'Business'}. Assert 200, question status=answered, linked transaction updated.
- `can bulk answer questions` -- Create 3 pending questions. POST /api/v1/questions/bulk-answer with array of answers. Assert 200, all questions answered.
- `skipping a question sets status to skipped` -- Create a pending question. POST /api/v1/questions/{id}/answer with {answer: 'Skip'}. Assert question status=skipped.

**File 5: tests/Feature/Subscription/SubscriptionTest.php** (TEST-06)
Tests:
- `can list subscriptions` -- createUserWithBank(), create Subscription records via factory. GET /api/v1/subscriptions. Assert 200, returns subscriptions with totals.
- `can detect subscriptions from transaction patterns` -- createUserWithBank(), create recurring Transaction records (same merchant, monthly intervals, similar amounts). POST /api/v1/subscriptions/detect. Assert 200, new Subscription records created.

**File 6: tests/Feature/Savings/SavingsTest.php** (TEST-07)
Tests:
- `can list savings recommendations` -- createUserWithBank(), create SavingsRecommendation records. GET /api/v1/savings. Assert 200, returns recommendations.
- `can set savings target` -- createUserWithBank(). POST /api/v1/savings/target with {monthly_target: 500, motivation: 'Emergency fund'}. Assert 200 or 201, SavingsTarget created.
- `can respond to plan action` -- Create a SavingsPlanAction. POST /api/v1/savings/plan/{action}/respond with {response: 'accept'}. Assert 200, action status updated.

**File 7: tests/Feature/Tax/TaxTest.php** (TEST-08)
Tests:
- `can get tax summary` -- createUserWithBankAndProfile() (needs profile.complete middleware). Create deductible Transaction records with tax_category set. GET /api/v1/tax/summary. Assert 200, response has summary with deductible totals grouped by category.
- `tax summary requires financial profile` -- createUserWithBank() (no profile). GET /api/v1/tax/summary. Assert 403 with message about completing financial profile.
NOTE: Skip export and send-to-accountant tests -- they require Python scripts for file generation. The tax summary test validates the core data logic.

**File 8: tests/Feature/Account/AccountDeletionTest.php** (TEST-09)
Tests:
- `can delete own account` -- Create authenticated user with bank connection and transactions. Http::fake Plaid disconnect. DELETE /api/v1/account with {password: 'password'}. Assert 204. Assert User::find($userId) is null. Assert BankConnection count for user is 0.
- `delete account requires correct password` -- DELETE /api/v1/account with {password: 'wrong'}. Assert 422.
- `delete account revokes all tokens` -- Create user with multiple tokens. DELETE /api/v1/account. Assert personal_access_tokens count is 0 for that user.
  </action>
  <verify>
Run `php artisan test --filter=ApiAuthTest` -- all auth tests pass.
Run `php artisan test --filter=PlaidFlowTest` -- all Plaid tests pass.
Run `php artisan test --filter=TransactionTest` -- all transaction tests pass.
Run `php artisan test --filter=AIQuestionTest` -- all AI question tests pass.
Run `php artisan test --filter=SubscriptionTest` -- all subscription tests pass.
Run `php artisan test --filter=SavingsTest` -- all savings tests pass.
Run `php artisan test --filter=TaxTest` -- all tax tests pass.
Run `php artisan test --filter=AccountDeletionTest` -- all deletion tests pass.
Then: `php artisan test` -- ALL tests pass (including existing Breeze tests).
  </verify>
  <done>
8 feature test files exist and pass. Auth flow covers register/login/logout/2FA/lockout. Plaid flow covers link token/exchange/sync/disconnect with Http::fake. Transaction tests cover listing with filters and category update. AI question tests cover list/answer/bulk-answer. Subscription tests cover list and detection. Savings tests cover recommendations/target/action-response. Tax test covers summary. Account deletion test covers cascade behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write all 4 unit test files</name>
  <files>
    tests/Unit/Services/TransactionCategorizerServiceTest.php,
    tests/Unit/Services/SubscriptionDetectorServiceTest.php,
    tests/Unit/Services/TaxExportServiceTest.php,
    tests/Unit/Services/CaptchaServiceTest.php
  </files>
  <action>
Create 4 Pest PHP unit test files in tests/Unit/Services/. Unit tests focus on service logic in isolation.

IMPORTANT: Unit tests in tests/Unit/ do NOT automatically get RefreshDatabase (that's only bound to tests/Feature/ in Pest.php). For unit tests that need the database, add `uses(\Illuminate\Foundation\Testing\RefreshDatabase::class)` at the top of the file. For pure logic tests, this is not needed.

**File 1: tests/Unit/Services/TransactionCategorizerServiceTest.php** (TEST-10)

This tests the `processCategorizationResults()` method's confidence routing logic. We need the database for real model interactions.

Add `uses(\Illuminate\Foundation\Testing\RefreshDatabase::class)` at top.

Tests:
- `auto-categorizes transactions with confidence >= 0.85` -- Create a user, bank connection, account, and uncategorized transaction. Use Http::fake to return a Claude response with confidence=0.92. Call `$service->categorizeBatch(collect([$tx]), $userId)`. Assert result['auto_categorized']=1, result['needs_review']=0. Assert $tx->fresh()->review_status is 'auto_categorized'. Assert NO AIQuestion created.

- `flags transactions for review with confidence 0.60-0.84` -- Http::fake with confidence=0.72 and a suggested_question. Call categorizeBatch. Assert result['needs_review']=1. Assert $tx->fresh()->review_status is 'needs_review'. Assert AIQuestion was created.

- `generates multiple-choice question for confidence 0.40-0.59` -- Http::fake with confidence=0.48 and question_options. Call categorizeBatch. Assert AIQuestion created with options array.

- `generates open-ended question for confidence < 0.40` -- Http::fake with confidence=0.25. Assert AIQuestion created with question_type set.

- `handleUserAnswer updates transaction for business_personal question` -- Create a question with question_type=business_personal linked to a transaction. Call handleUserAnswer($question, 'Business'). Assert transaction expense_type='business', tax_deductible=true, review_status='user_confirmed'.

- `handleUserAnswer skips transaction when answer is Skip` -- Call handleUserAnswer($question, 'Skip'). Assert question status='skipped'. Assert transaction NOT updated.

Http::fake pattern for Anthropic:
```php
Http::fake([
    'api.anthropic.com/*' => Http::response([
        'content' => [['text' => json_encode([
            [
                'id' => $tx->id,
                'category' => 'Food & Groceries',
                'confidence' => 0.92,
                'expense_type' => 'personal',
                'tax_deductible' => false,
                'tax_category' => null,
                'is_subscription' => false,
                'merchant_normalized' => 'Whole Foods',
                'reasoning' => 'Grocery store purchase',
                'uncertain_about' => null,
                'suggested_question' => null,
                'question_type' => null,
                'question_options' => null,
            ],
        ])]],
    ]),
]);
```

**File 2: tests/Unit/Services/SubscriptionDetectorServiceTest.php** (TEST-11)

This tests the `analyzeRecurrence()` method. Since it's protected, test through `detectSubscriptions()` with real DB data.

Add `uses(\Illuminate\Foundation\Testing\RefreshDatabase::class)` at top.

Tests:
- `detects monthly subscriptions from recurring charges` -- Create a user, bank, account, and 3+ Transaction records for the same merchant (e.g., 'NETFLIX') with ~30 day intervals and similar amounts ($15.99, $15.99, $15.99) over 3 months. Call `$service->detectSubscriptions($userId)`. Assert result['detected'] >= 1. Assert Subscription record exists for Netflix with frequency='monthly'.

- `detects weekly subscriptions from frequent charges` -- Create 4+ transactions for same merchant with ~7 day intervals. Call detectSubscriptions. Assert detected subscription with frequency='weekly'.

- `does not detect subscription from inconsistent charges` -- Create 2 transactions for same merchant with wildly different amounts (e.g., $15 and $150) at irregular intervals. Call detectSubscriptions. Assert result['detected']=0 or that those transactions were not detected as a subscription.

- `does not detect subscription from single charge` -- Create 1 transaction. Call detectSubscriptions. Assert not detected (minimum 2 charges required by the service).

- `marks subscriptions as unused when no recent activity` -- Create a Subscription record with last_charge_date 45 days ago, is_essential=false. Call detectSubscriptions. Assert subscription status updated to 'unused'.

**File 3: tests/Unit/Services/TaxExportServiceTest.php** (TEST-12)

This tests `mapToScheduleC()`. Since it's protected, use a ReflectionMethod to test directly, or test through `gatherTaxData()` by creating real DB data (but skip file generation).

Add `uses(\Illuminate\Foundation\Testing\RefreshDatabase::class)` at top.

Tests:
- `maps Marketing & Advertising to Schedule C Line 8` -- Use ReflectionMethod to call mapToScheduleC with test data: [['tax_category' => 'Marketing & Advertising', 'total' => 500, 'item_count' => 5]]. Assert result has line '8' with label 'Advertising'.

- `maps Gas & Fuel to Schedule C Line 9` -- mapToScheduleC with [['tax_category' => 'Gas & Fuel', 'total' => 300, 'item_count' => 10]]. Assert line '9', label 'Car and truck expenses'.

- `maps Office Supplies to Schedule C Line 18` -- mapToScheduleC with [['tax_category' => 'Office Supplies', 'total' => 200, 'item_count' => 8]]. Assert line '18', label 'Office expense'.

- `maps unknown category to Line 27a (Other expenses)` -- mapToScheduleC with [['tax_category' => 'Some Random Category', 'total' => 100, 'item_count' => 2]]. Assert line '27a', label 'Other expenses'.

- `aggregates multiple categories to same line` -- mapToScheduleC with both 'Gas & Fuel' (300) and 'Auto Maintenance' (200). Assert single Line 9 entry with total=500 and 2 categories.

- `gatherTaxData returns correct deductible totals` -- Create user, profile, bank, account, and deductible transactions for the test year. Call gatherTaxData (use reflection since it's protected). Assert summary.total_deductible_transactions matches sum of deductible amounts.

**File 4: tests/Unit/Services/CaptchaServiceTest.php** (TEST-13)

This tests the CaptchaService's verify() method logic. Pure logic with Http::fake -- no database needed.

Tests:
- `returns true when captcha is disabled` -- Set config('spendwise.captcha.enabled', false). Call verify('any-token'). Assert true.

- `returns true for score above threshold` -- Set config('spendwise.captcha.enabled', true). Http::fake the reCAPTCHA verify URL to return success=true, score=0.9, action='login'. Call verify('token', 'login'). Assert true.

- `returns false for score below threshold` -- Http::fake with success=true, score=0.2. Call verify('token', 'login'). Assert false.

- `returns false for action mismatch` -- Http::fake with success=true, score=0.9, action='register'. Call verify('token', 'login'). Assert false (expected 'login' but got 'register').

- `returns false when API returns failure` -- Http::fake with success=false, error-codes=['invalid-input-response']. Call verify('bad-token'). Assert false.

- `returns false on API exception` -- Http::fake to throw an exception. Call verify('token'). Assert false (fail-closed behavior).
  </action>
  <verify>
Run `php artisan test --testsuite=Unit` -- all unit tests pass.
Run `php artisan test` -- ALL tests pass (feature + unit + existing Breeze).
  </verify>
  <done>
4 unit test files exist and pass. TransactionCategorizerServiceTest covers all 4 confidence thresholds and handleUserAnswer behavior. SubscriptionDetectorServiceTest covers monthly/weekly detection, inconsistent/single charge rejection, and unused marking. TaxExportServiceTest covers Schedule C line mapping for known categories, unknown fallback, and aggregation. CaptchaServiceTest covers disabled config, score thresholds, action mismatch, API failure, and exception handling.
  </done>
</task>

</tasks>

<verification>
1. `php artisan test` -- ALL tests pass (existing Breeze + 8 new feature + 4 new unit)
2. `php artisan test --testsuite=Feature` -- all feature tests pass
3. `php artisan test --testsuite=Unit` -- all unit tests pass
4. No test hits real external APIs (Plaid, Anthropic, reCAPTCHA) -- all use Http::fake
</verification>

<success_criteria>
- 8 feature test files covering TEST-02 through TEST-09 requirements
- 4 unit test files covering TEST-10 through TEST-13 requirements
- All tests pass when run with `php artisan test`
- No real external API calls in any test
- Existing Breeze auth tests still pass untouched
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-deployment/05-02-SUMMARY.md`
</output>
