---
phase: 05-testing-deployment
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - .github/workflows/ci.yml
  - .env.production.example
autonomous: true

must_haves:
  truths:
    - "GitHub Actions CI workflow exists and would run on push/PR to main/master"
    - "CI workflow uses PostgreSQL 15 and Redis 7 service containers"
    - "CI workflow installs PHP + Node deps, builds frontend, runs Pint lint, runs migrations, runs Pest tests"
    - "Production .env template documents every required environment variable with clear descriptions"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI pipeline"
      contains: "postgres"
    - path: ".env.production.example"
      provides: "Production environment variable template"
      contains: "APP_ENV=production"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "vendor/bin/pest"
      via: "Test runner invocation"
      pattern: "vendor/bin/pest"
    - from: ".github/workflows/ci.yml"
      to: "npm run build"
      via: "Frontend build step"
      pattern: "npm run build"
---

<objective>
Set up the GitHub Actions CI pipeline and create a production environment template documenting all required variables.

Purpose: Automate quality gates (lint, build, test) on every push/PR, and provide a complete reference for production deployment configuration.
Output: .github/workflows/ci.yml and .env.production.example
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-testing-deployment/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml` with the following configuration:

**Trigger:** Push to main/master branches AND pull requests targeting main/master.

**Services:**
- PostgreSQL 15 container: user=spendwise_test, password=password, db=spendwise_test, port 5432, with health checks (pg_isready)
- Redis 7 container: port 6379, with health checks (redis-cli ping)

**Environment variables for the job:**
- APP_ENV=testing
- APP_KEY=base64:dGVzdGtleWZvcmNpMTIzNDU2Nzg5MDEyMzQ1Njc4OTA= (a valid 32-byte base64 key for CI)
- DB_CONNECTION=pgsql, DB_HOST=127.0.0.1, DB_PORT=5432, DB_DATABASE=spendwise_test, DB_USERNAME=spendwise_test, DB_PASSWORD=password
- CACHE_STORE=array, QUEUE_CONNECTION=sync, SESSION_DRIVER=array, MAIL_MAILER=array
- BROADCAST_CONNECTION=log
- Do NOT set RECAPTCHA_SITE_KEY, ANTHROPIC_API_KEY, PLAID_CLIENT_ID (captcha disabled, APIs use Http::fake in tests)

**Steps (in order):**
1. `actions/checkout@v4` -- Checkout code
2. `shivammathur/setup-php@v2` -- Setup PHP 8.2 with extensions: mbstring, dom, fileinfo, pgsql, redis. Tools: composer:v2. Coverage: none.
3. `actions/cache@v4` -- Cache Composer dependencies (key: composer-${{ hashFiles('composer.lock') }})
4. `composer install --no-interaction --prefer-dist --optimize-autoloader` -- Install PHP deps
5. `actions/setup-node@v4` -- Setup Node.js 20 with npm cache
6. `npm ci` -- Install Node dependencies
7. `npm run build` -- Build frontend assets (Vite)
8. `vendor/bin/pint --test` -- Run Laravel Pint linter (fail on style violations)
9. `php artisan migrate --force` -- Run database migrations
10. `vendor/bin/pest --ci` -- Run full test suite

Note: Do NOT install Python or Python dependencies. Tax export tests skip file generation (test data logic only). The `--ci` flag gives Pest CI-friendly output.
  </action>
  <verify>
Verify the YAML is valid: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))" 2>&1 || echo "YAML invalid"`
Verify the file exists at the correct path: `ls -la .github/workflows/ci.yml`
  </verify>
  <done>
.github/workflows/ci.yml exists with PostgreSQL 15 + Redis 7 service containers, PHP 8.2 setup, Composer + npm installs, frontend build, Pint lint, migrations, and Pest test run. Triggers on push/PR to main/master.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create production .env template with documented variables</name>
  <files>.env.production.example</files>
  <action>
Create `.env.production.example` -- a fully documented production environment template. Group variables by concern with clear comments explaining each one, what it does, where to get it, and any security notes.

Structure:

```bash
# ============================================================
# SPENDWISE — Production Environment Configuration
# ============================================================
# Copy to .env on your production server and fill in all values.
# NEVER commit .env to version control.
# ============================================================

# ─── Application ───────────────────────────────────────────
APP_NAME=SpendWise
APP_ENV=production
APP_KEY=                    # Generate: php artisan key:generate --show
APP_DEBUG=false             # MUST be false in production
APP_URL=https://your-domain.com
FRONTEND_URL=https://your-domain.com

# ─── Database (PostgreSQL 15+) ─────────────────────────────
DB_CONNECTION=pgsql
DB_HOST=127.0.0.1          # Or your managed DB host
DB_PORT=5432
DB_DATABASE=spendwise
DB_USERNAME=spendwise
DB_PASSWORD=                # Strong password required

# ─── Redis (7+) ───────────────────────────────────────────
# Required for queues, caching, and sessions
REDIS_HOST=127.0.0.1       # Or your managed Redis host
REDIS_PASSWORD=null         # Set if Redis requires auth
REDIS_PORT=6379
CACHE_STORE=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis

# ─── Mail ──────────────────────────────────────────────────
# Used for: password resets, email verification, tax export delivery, notifications
# Recommended: Mailgun, SES, or Postmark for production
MAIL_MAILER=smtp            # smtp, mailgun, ses, postmark
MAIL_HOST=                  # e.g., smtp.mailgun.org
MAIL_PORT=587
MAIL_USERNAME=
MAIL_PASSWORD=
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@your-domain.com
MAIL_FROM_NAME="SpendWise"

# Mailgun (if MAIL_MAILER=mailgun):
# MAILGUN_DOMAIN=mg.your-domain.com
# MAILGUN_SECRET=key-xxxxxxx

# SES (if MAIL_MAILER=ses):
# AWS_ACCESS_KEY_ID=
# AWS_SECRET_ACCESS_KEY=
# AWS_DEFAULT_REGION=us-east-1

# ─── Plaid (Bank Integration) ─────────────────────────────
# Dashboard: https://dashboard.plaid.com/developers/keys
# Start with sandbox/development, apply for production access
PLAID_CLIENT_ID=            # From Plaid Dashboard -> Team Settings -> Keys
PLAID_SECRET=               # From Plaid Dashboard (use production secret)
PLAID_ENV=production        # sandbox | development | production
PLAID_WEBHOOK_URL=https://your-domain.com/api/v1/webhooks/plaid  # Required in production

# ─── Anthropic (AI Categorization) ────────────────────────
# Console: https://console.anthropic.com/
ANTHROPIC_API_KEY=          # From Anthropic Console -> API Keys
ANTHROPIC_MODEL=claude-sonnet-4-20250514

# ─── Google OAuth (Social Login) ──────────────────────────
# Console: https://console.cloud.google.com/apis/credentials
# Enable: Google+ API, Gmail API
# Add authorized redirect URI: {APP_URL}/auth/google/callback
GOOGLE_CLIENT_ID=           # From Google Cloud Console
GOOGLE_CLIENT_SECRET=       # From Google Cloud Console
GOOGLE_REDIRECT_URI="${APP_URL}/auth/google/callback"

# ─── Google reCAPTCHA v3 ──────────────────────────────────
# Get keys: https://www.google.com/recaptcha/admin
# Choose reCAPTCHA v3 (invisible, score-based)
RECAPTCHA_SITE_KEY=         # Public key (used in frontend)
RECAPTCHA_SECRET_KEY=       # Secret key (server-side verification)
RECAPTCHA_THRESHOLD=0.5     # Score threshold (0.0 = bot, 1.0 = human)

# ─── Sanctum (API Auth) ───────────────────────────────────
SANCTUM_STATEFUL_DOMAINS=your-domain.com

# ─── Two-Factor Authentication ─────────────────────────────
TWO_FACTOR_ENABLED=true

# ─── Session / Security ───────────────────────────────────
SESSION_LIFETIME=120
SESSION_ENCRYPT=true

# ─── Logging ──────────────────────────────────────────────
LOG_CHANNEL=daily           # daily | stack | single | stderr (for Docker)
LOG_LEVEL=warning           # Use 'warning' in production (not 'debug')

# ─── Queue Worker ─────────────────────────────────────────
# Run: php artisan queue:work redis --tries=3 --timeout=90
# Consider Laravel Horizon for production queue management

# ─── Scheduler ────────────────────────────────────────────
# Add to crontab: * * * * * cd /path/to/app && php artisan schedule:run >> /dev/null 2>&1

# ─── TLS / Security Headers ──────────────────────────────
# Configure in your reverse proxy (Nginx/Caddy):
# - TLS 1.2+ only
# - HSTS header
# - X-Content-Type-Options: nosniff
# - X-Frame-Options: DENY
# - Content-Security-Policy (restrict to your domain)
```

Ensure every variable from .env.example is included, plus production-specific additions (LOG_LEVEL=warning, APP_DEBUG=false, PLAID_ENV=production, PLAID_WEBHOOK_URL).
  </action>
  <verify>
Verify file exists: `ls -la .env.production.example`
Verify key sections present: `grep -c "APP_ENV=production" .env.production.example && grep -c "PLAID_WEBHOOK_URL" .env.production.example && grep -c "LOG_LEVEL=warning" .env.production.example`
  </verify>
  <done>
.env.production.example exists with all required variables documented, grouped by concern, with clear descriptions of where to get each value. Includes production-specific settings (APP_DEBUG=false, LOG_LEVEL=warning, PLAID_ENV=production, PLAID_WEBHOOK_URL). Security notes for TLS and queue worker configuration included as comments.
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/ci.yml` is valid YAML
2. CI workflow includes PostgreSQL + Redis service containers
3. CI workflow runs: checkout, PHP setup, composer install, node setup, npm ci, npm build, pint lint, migrate, pest
4. `.env.production.example` documents all variables from .env.example plus production additions
5. No secrets committed in either file
</verification>

<success_criteria>
- GitHub Actions CI pipeline would trigger on push/PR to main/master
- CI uses PostgreSQL 15 + Redis 7 (not SQLite)
- CI runs lint (Pint), build (Vite), and test (Pest) steps
- Production .env template documents every required variable with explanations
- Both files committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-deployment/05-03-SUMMARY.md`
</output>
