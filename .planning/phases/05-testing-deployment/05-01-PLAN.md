---
phase: 05-testing-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - phpunit.xml
  - .env.testing
  - tests/Pest.php
  - app/Models/BankConnection.php
  - app/Models/BankAccount.php
  - app/Models/Transaction.php
  - app/Models/Subscription.php
  - app/Models/AIQuestion.php
  - app/Models/EmailConnection.php
  - app/Models/ParsedEmail.php
  - app/Models/Order.php
  - app/Models/OrderItem.php
  - app/Models/ExpenseCategory.php
  - app/Models/SavingsRecommendation.php
  - app/Models/SavingsTarget.php
  - app/Models/SavingsPlanAction.php
  - app/Models/SavingsProgress.php
  - app/Models/BudgetGoal.php
  - app/Models/UserFinancialProfile.php
  - app/Models/PlaidWebhookLog.php
  - database/factories/UserFactory.php
  - database/factories/BankConnectionFactory.php
  - database/factories/BankAccountFactory.php
  - database/factories/TransactionFactory.php
  - database/factories/SubscriptionFactory.php
  - database/factories/AIQuestionFactory.php
  - database/factories/EmailConnectionFactory.php
  - database/factories/ParsedEmailFactory.php
  - database/factories/OrderFactory.php
  - database/factories/OrderItemFactory.php
  - database/factories/ExpenseCategoryFactory.php
  - database/factories/SavingsRecommendationFactory.php
  - database/factories/SavingsTargetFactory.php
  - database/factories/SavingsPlanActionFactory.php
  - database/factories/SavingsProgressFactory.php
  - database/factories/BudgetGoalFactory.php
  - database/factories/UserFinancialProfileFactory.php
  - database/factories/PlaidWebhookLogFactory.php
autonomous: true

must_haves:
  truths:
    - "All 18 models support ::factory() calls without errors"
    - "Test database uses PostgreSQL (not SQLite) so all migrations including column changes succeed"
    - "Helper functions createAuthenticatedUser() and createUserWithBank() are available in all tests"
    - "Factories produce valid records that pass all foreign key constraints and enum validations"
  artifacts:
    - path: ".env.testing"
      provides: "PostgreSQL test database configuration"
      contains: "DB_CONNECTION=pgsql"
    - path: "phpunit.xml"
      provides: "Test runner configuration without SQLite overrides"
    - path: "tests/Pest.php"
      provides: "Test helper functions for authenticated user + bank setup"
      contains: "createAuthenticatedUser"
    - path: "database/factories/TransactionFactory.php"
      provides: "Transaction factory with enum states"
      contains: "ExpenseType::Personal"
    - path: "database/factories/BankConnectionFactory.php"
      provides: "BankConnection factory with active/error states"
      contains: "ConnectionStatus::Active"
  key_links:
    - from: "app/Models/BankConnection.php"
      to: "database/factories/BankConnectionFactory.php"
      via: "HasFactory trait"
      pattern: "use HasFactory"
    - from: "database/factories/TransactionFactory.php"
      to: "database/factories/BankAccountFactory.php"
      via: "Factory relationship chaining"
      pattern: "BankAccount::factory"
---

<objective>
Set up the test infrastructure and create all model factories so that feature and unit tests can be written against a PostgreSQL test database with realistic data.

Purpose: This is the foundation for all testing. Without factories and proper database config, no test can create test data. Every subsequent test plan depends on this.
Output: .env.testing, updated phpunit.xml, HasFactory trait on 17 models, 17 new factory files, enhanced UserFactory, Pest.php test helpers.
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-testing-deployment/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure PostgreSQL test database and fix phpunit.xml</name>
  <files>phpunit.xml, .env.testing</files>
  <action>
1. Create `.env.testing` with PostgreSQL configuration for the test database:
   - APP_ENV=testing, APP_KEY (copy from .env or generate), APP_DEBUG=true
   - DB_CONNECTION=pgsql, DB_HOST=127.0.0.1, DB_PORT=5432, DB_DATABASE=spendwise_test, DB_USERNAME=spendwise, DB_PASSWORD= (empty for local)
   - CACHE_STORE=array, QUEUE_CONNECTION=sync, SESSION_DRIVER=array, MAIL_MAILER=array
   - Do NOT set RECAPTCHA_SITE_KEY (leaves captcha disabled for tests)
   - Do NOT set ANTHROPIC_API_KEY or PLAID_CLIENT_ID (tests use Http::fake)

2. Update `phpunit.xml`:
   - REMOVE the two lines: `<env name="DB_CONNECTION" value="sqlite"/>` and `<env name="DB_DATABASE" value=":memory:"/>`
   - Keep all other env overrides (APP_ENV=testing, CACHE_STORE=array, etc.)
   - This lets .env.testing provide the PostgreSQL config

3. Create the test database if it does not exist:
   - Run: `psql -U spendwise -c "SELECT 1 FROM pg_database WHERE datname='spendwise_test'" | grep -q 1 || psql -U spendwise -c "CREATE DATABASE spendwise_test;"`
   - If psql fails due to auth, try: `sudo -u postgres createdb spendwise_test` or `PGPASSWORD="" createdb -U spendwise spendwise_test`

4. Verify: Run `php artisan migrate --env=testing --force` to confirm PostgreSQL migrations work (especially migration 000005 with column changes).

CRITICAL: SQLite CANNOT run the ->change() calls in migration 000005_encrypt_sensitive_columns. PostgreSQL is mandatory. This was confirmed in research.
  </action>
  <verify>
Run `php artisan migrate --env=testing --force` -- should complete without errors.
Run `php artisan test --filter=ExampleTest` -- should pass (uses PostgreSQL now).
  </verify>
  <done>phpunit.xml no longer references SQLite. .env.testing exists with PostgreSQL config. Migrations run successfully against spendwise_test database. Existing example tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add HasFactory trait to 17 models and create all 18 factories</name>
  <files>
    app/Models/BankConnection.php, app/Models/BankAccount.php, app/Models/Transaction.php,
    app/Models/Subscription.php, app/Models/AIQuestion.php, app/Models/EmailConnection.php,
    app/Models/ParsedEmail.php, app/Models/Order.php, app/Models/OrderItem.php,
    app/Models/ExpenseCategory.php, app/Models/SavingsRecommendation.php, app/Models/SavingsTarget.php,
    app/Models/SavingsPlanAction.php, app/Models/SavingsProgress.php, app/Models/BudgetGoal.php,
    app/Models/UserFinancialProfile.php, app/Models/PlaidWebhookLog.php,
    database/factories/UserFactory.php,
    database/factories/BankConnectionFactory.php, database/factories/BankAccountFactory.php,
    database/factories/TransactionFactory.php, database/factories/SubscriptionFactory.php,
    database/factories/AIQuestionFactory.php, database/factories/EmailConnectionFactory.php,
    database/factories/ParsedEmailFactory.php, database/factories/OrderFactory.php,
    database/factories/OrderItemFactory.php, database/factories/ExpenseCategoryFactory.php,
    database/factories/SavingsRecommendationFactory.php, database/factories/SavingsTargetFactory.php,
    database/factories/SavingsPlanActionFactory.php, database/factories/SavingsProgressFactory.php,
    database/factories/BudgetGoalFactory.php, database/factories/UserFinancialProfileFactory.php,
    database/factories/PlaidWebhookLogFactory.php
  </files>
  <action>
**Step 1: Add HasFactory trait to all 17 models (NOT User -- it already has it).**

For each model file, add `use Illuminate\Database\Eloquent\Factories\HasFactory;` to imports and `use HasFactory;` inside the class body. The 17 models are: BankConnection, BankAccount, Transaction, Subscription, AIQuestion, EmailConnection, ParsedEmail, Order, OrderItem, ExpenseCategory, SavingsRecommendation, SavingsTarget, SavingsPlanAction, SavingsProgress, BudgetGoal, UserFinancialProfile, PlaidWebhookLog.

**Step 2: Enhance existing UserFactory** -- add states for 2FA-enabled user and Google-connected user:
- `withTwoFactor()`: sets `two_factor_secret` to a test value, `two_factor_confirmed_at` to now()
- `withGoogle()`: sets `google_id` to fake uuid, `google_avatar` to fake url

**Step 3: Create 17 new factory files.** Each factory MUST:
- Use the correct enum values (not raw strings) for enum-cast fields
- Provide plain values for encrypted fields (model casts handle encryption)
- Chain User::factory() for user_id foreign keys
- Chain parent factories for nested FKs (e.g., Transaction needs BankAccount which needs BankConnection)

Factory specifications by model:

**BankConnectionFactory:**
- definition: user_id => User::factory(), plaid_item_id => 'item_'.fake()->uuid(), plaid_access_token => 'access-sandbox-'.fake()->uuid(), institution_name => fake()->randomElement(['Chase','Bank of America','Wells Fargo','Capital One']), institution_id => 'ins_'.fake()->randomNumber(6), status => ConnectionStatus::Active
- States: active() => status=Active + last_synced_at=now(); error() => status=Error + error_code='ITEM_LOGIN_REQUIRED' + error_message='Login required'; disconnected() => status=Disconnected
- Add `->for()` helper: `public function for($parent)` -- support User relationships via `->for($user)`

**BankAccountFactory:**
- definition: user_id => User::factory(), bank_connection_id => BankConnection::factory(), plaid_account_id => 'acc_'.fake()->uuid(), name => fake()->randomElement(['Checking','Savings','Credit Card']), type => 'depository', subtype => 'checking', mask => fake()->numerify('####'), purpose => AccountPurpose::Personal, current_balance => fake()->randomFloat(2,100,10000), available_balance => fake()->randomFloat(2,100,10000), is_active => true
- States: business() => purpose=AccountPurpose::Business; personal() => purpose=AccountPurpose::Personal

**TransactionFactory:**
- definition: user_id => User::factory(), bank_account_id => BankAccount::factory(), plaid_transaction_id => 'txn_'.fake()->uuid(), merchant_name => fake()->company(), amount => fake()->randomFloat(2,1,500), transaction_date => fake()->dateTimeBetween('-6 months'), payment_channel => fake()->randomElement(['online','in store','other']), plaid_category => fake()->randomElement(['FOOD_AND_DRINK','SHOPPING','TRANSPORTATION']), expense_type => ExpenseType::Personal, account_purpose => AccountPurpose::Personal, review_status => ReviewStatus::PendingAI, tax_deductible => false, is_subscription => false
- States: categorized() => ai_category=random category, ai_confidence=0.90, review_status=AutoCategorized; needsReview() => ai_category='Uncategorized', ai_confidence=0.45, review_status=NeedsReview; business() => expense_type=Business, account_purpose=Business, tax_deductible=true; deductible() => tax_deductible=true, tax_category=random from ['Office Supplies','Software & SaaS','Business Meals']; subscription() => is_subscription=true, merchant_name=random from ['NETFLIX','SPOTIFY','ADOBE']

**SubscriptionFactory:**
- definition: user_id => User::factory(), merchant_name => fake()->company(), merchant_normalized => fake()->company(), amount => fake()->randomFloat(2,5,50), frequency => 'monthly', category => fake()->randomElement(['Streaming','Software','Fitness']), status => SubscriptionStatus::Active, is_essential => false, last_charge_date => fake()->dateTimeBetween('-30 days'), next_expected_date => fake()->dateTimeBetween('now','+30 days'), annual_cost => fn(array $attrs) => round($attrs['amount'] * 12, 2), charge_history => []
- States: unused() => status=SubscriptionStatus::Unused; essential() => is_essential=true

**AIQuestionFactory:**
- definition: user_id => User::factory(), transaction_id => Transaction::factory(), question => fake()->sentence().'?', options => ['Personal','Business','Mixed','Skip'], question_type => QuestionType::BusinessPersonal, ai_confidence => fake()->randomFloat(2,0.30,0.59), ai_best_guess => fake()->randomElement(['Food & Groceries','Office Supplies']), status => QuestionStatus::Pending
- States: answered() => status=QuestionStatus::Answered, user_answer='Business', answered_at=now(); category() => question_type=QuestionType::Category, options=['Food & Groceries','Restaurant & Dining','Shopping (General)','Skip']

**EmailConnectionFactory:**
- definition: user_id => User::factory(), provider => 'gmail', email_address => fake()->safeEmail(), access_token => 'ya29.test-'.fake()->uuid(), refresh_token => '1//test-'.fake()->uuid(), token_expires_at => now()->addHour(), status => ConnectionStatus::Active

**ParsedEmailFactory:**
- definition: user_id => User::factory(), email_connection_id => EmailConnection::factory(), email_message_id => fake()->uuid(), is_purchase => true, is_refund => false, is_subscription => false, raw_parsed_data => ['merchant'=>fake()->company(),'total'=>fake()->randomFloat(2,10,200),'items'=>[]], parse_status => 'parsed', email_date => fake()->dateTimeBetween('-3 months')

**OrderFactory:**
- definition: user_id => User::factory(), parsed_email_id => ParsedEmail::factory(), merchant => fake()->company(), order_number => fake()->bothify('ORD-###-???'), order_date => fake()->dateTimeBetween('-3 months'), subtotal => fake()->randomFloat(2,10,200), tax => fn(array $a) => round($a['subtotal']*0.08,2), shipping => fake()->randomFloat(2,0,15), total => fn(array $a) => round($a['subtotal']+$a['tax']+$a['shipping'],2)

**OrderItemFactory:**
- definition: user_id => User::factory(), order_id => Order::factory(), product_name => fake()->words(3,true), quantity => fake()->numberBetween(1,5), unit_price => fake()->randomFloat(2,5,100), total_price => fn(array $a) => round($a['unit_price']*$a['quantity'],2), tax_deductible => false

**ExpenseCategoryFactory:**
- definition: name => fake()->unique()->words(2,true), slug => fn(array $a) => \Str::slug($a['name']), is_system => true, is_typically_deductible => false, keywords => []

**SavingsRecommendationFactory:**
- definition: user_id => User::factory(), title => fake()->sentence(4), description => fake()->paragraph(), monthly_savings => fake()->randomFloat(2,10,200), annual_savings => fn(array $a) => round($a['monthly_savings']*12,2), difficulty => fake()->randomElement(['easy','medium','hard']), impact => fake()->randomElement(['low','medium','high']), category => fake()->randomElement(['subscriptions','dining','shopping']), status => 'active', action_steps => ['Step 1: Review charges','Step 2: Cancel unused'], related_merchants => ['Netflix','Spotify'], generated_at => now()

**SavingsTargetFactory:**
- definition: user_id => User::factory(), monthly_target => fake()->randomFloat(2,100,1000), motivation => fake()->sentence(), target_start_date => now()->startOfMonth(), target_end_date => now()->addMonths(6)->endOfMonth(), goal_total => fn(array $a) => round($a['monthly_target']*6,2), is_active => true

**SavingsPlanActionFactory:**
- definition: user_id => User::factory(), savings_target_id => SavingsTarget::factory(), title => fake()->sentence(4), description => fake()->paragraph(), how_to => fake()->paragraph(), monthly_savings => fake()->randomFloat(2,10,100), current_spending => fake()->randomFloat(2,50,300), recommended_spending => fn(array $a) => round($a['current_spending']-$a['monthly_savings'],2), category => fake()->randomElement(['Streaming','Dining','Shopping']), difficulty => fake()->randomElement(['easy','medium','hard']), impact => fake()->randomElement(['low','medium','high']), priority => fake()->numberBetween(1,5), status => 'pending'
- States: accepted() => status='accepted', user_response='yes', accepted_at=now(); rejected() => status='rejected', user_response='no', rejected_at=now(), rejection_reason='Not feasible'

**SavingsProgressFactory:**
- definition: user_id => User::factory(), savings_target_id => SavingsTarget::factory(), month => now()->format('Y-m'), income => fake()->randomFloat(2,3000,8000), total_spending => fake()->randomFloat(2,2000,6000), actual_savings => fn(array $a) => round($a['income']-$a['total_spending'],2), target_savings => fake()->randomFloat(2,200,800), target_met => fn(array $a) => $a['actual_savings'] >= $a['target_savings']
- Note: table name is `savings_progress` (set via $table on the model)

**BudgetGoalFactory:**
- definition: user_id => User::factory(), category => fake()->randomElement(['Food & Groceries','Restaurant & Dining','Shopping (General)','Entertainment']), monthly_limit => fake()->randomFloat(2,100,1000), alert_threshold => 0.80

**UserFinancialProfileFactory:**
- definition: user_id => User::factory(), employment_type => fake()->randomElement(['self_employed','employed','freelancer']), business_type => fake()->randomElement(['consulting','technology','creative']), has_home_office => fake()->boolean(70), tax_filing_status => fake()->randomElement(['single','married_jointly','head_of_household']), estimated_tax_bracket => fake()->randomElement([12,22,24,32]), monthly_income => fake()->randomFloat(2,3000,10000), monthly_savings_goal => fake()->randomFloat(2,200,1000), custom_rules => null
- Note: monthly_income and custom_rules are encrypted fields -- provide PLAIN values, model casts encrypt automatically

**PlaidWebhookLogFactory:**
- definition: webhook_type => 'TRANSACTIONS', webhook_code => fake()->randomElement(['SYNC_UPDATES_AVAILABLE','DEFAULT_UPDATE','INITIAL_UPDATE']), item_id => 'item_'.fake()->uuid(), payload => ['webhook_type'=>'TRANSACTIONS','webhook_code'=>'SYNC_UPDATES_AVAILABLE'], status => 'processed', processed_at => now()

**Step 4: Update tests/Pest.php** -- add helper functions after the existing `something()` function:

```php
function createAuthenticatedUser(array $attrs = []): \App\Models\User
{
    $user = \App\Models\User::factory()->create($attrs);
    \Laravel\Sanctum\Sanctum::actingAs($user);
    return $user;
}

function createUserWithBank(array $userAttrs = []): array
{
    $user = createAuthenticatedUser($userAttrs);
    $connection = \App\Models\BankConnection::factory()->create(['user_id' => $user->id, 'status' => \App\Enums\ConnectionStatus::Active, 'last_synced_at' => now()]);
    $account = \App\Models\BankAccount::factory()->create(['user_id' => $user->id, 'bank_connection_id' => $connection->id]);
    return compact('user', 'connection', 'account');
}

function createUserWithBankAndProfile(array $userAttrs = []): array
{
    $data = createUserWithBank($userAttrs);
    $profile = \App\Models\UserFinancialProfile::factory()->create([
        'user_id' => $data['user']->id,
        'employment_type' => 'self_employed',
    ]);
    return array_merge($data, ['profile' => $profile]);
}
```

Remove the placeholder `something()` function.
  </action>
  <verify>
Run a quick tinker test to confirm factories work:
```
php artisan tinker --execute="
  \App\Models\User::factory()->create();
  \App\Models\BankConnection::factory()->create();
  \App\Models\Transaction::factory()->create();
  echo 'All factories work';
"
```
Or better: Run `php artisan test` to confirm existing tests still pass with new infrastructure.
  </verify>
  <done>
All 18 models have HasFactory trait. All 18 factories exist and produce valid records. UserFactory has withTwoFactor() and withGoogle() states. TransactionFactory has categorized/needsReview/business/deductible/subscription states. BankConnectionFactory has active/error/disconnected states. Pest.php has createAuthenticatedUser(), createUserWithBank(), createUserWithBankAndProfile() helpers. Running `php artisan test` passes.
  </done>
</task>

</tasks>

<verification>
1. Run `php artisan test` -- all existing tests pass with PostgreSQL backend
2. Run `php artisan tinker --execute="App\Models\Transaction::factory()->create(); echo 'OK';"` -- creates record without FK errors
3. Confirm .env.testing has DB_CONNECTION=pgsql
4. Confirm phpunit.xml does NOT contain sqlite or :memory:
</verification>

<success_criteria>
- All 18 model factories produce valid records with correct enum values and encrypted fields
- Test database is PostgreSQL (not SQLite)
- Helper functions available in Pest.php for creating authenticated users with bank connections
- `php artisan test` passes all existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-deployment/05-01-SUMMARY.md`
</output>
