---
phase: 03-ai-intelligence-financial-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Models/AIQuestion.php
  - app/Http/Controllers/Api/PlaidController.php
  - app/Http/Controllers/Api/AIQuestionController.php
  - routes/console.php
autonomous: true

must_haves:
  truths:
    - "After transaction sync, CategorizePendingTransactions job is dispatched to categorize uncategorized transactions via Claude API"
    - "Transactions with confidence >= 0.85 are auto-categorized; 0.60-0.84 flagged for review; below 0.60 generate AI questions"
    - "User can view pending AI questions with transaction context"
    - "User can answer a single question or bulk-answer, and answers update the transaction category"
    - "Unanswered questions expire after 7 days via scheduled task"
  artifacts:
    - path: "app/Models/AIQuestion.php"
      provides: "AIQuestion model with corrected $fillable matching both DB schema and service writes"
      contains: "ai_confidence"
    - path: "app/Http/Controllers/Api/PlaidController.php"
      provides: "PlaidController that dispatches categorization after sync"
      contains: "CategorizePendingTransactions"
    - path: "routes/console.php"
      provides: "Active scheduled task for question expiry"
      contains: "expire-ai-questions"
  key_links:
    - from: "app/Http/Controllers/Api/PlaidController.php"
      to: "app/Jobs/CategorizePendingTransactions.php"
      via: "dispatch after sync completes"
      pattern: "CategorizePendingTransactions::dispatch"
    - from: "app/Services/AI/TransactionCategorizerService.php"
      to: "app/Models/AIQuestion.php"
      via: "AIQuestion::create with ai_confidence and ai_best_guess"
      pattern: "AIQuestion::create"
    - from: "app/Http/Controllers/Api/AIQuestionController.php"
      to: "app/Services/AI/TransactionCategorizerService.php"
      via: "handleUserAnswer updates transaction category"
      pattern: "handleUserAnswer"
---

<objective>
Wire up the AI categorization pipeline end-to-end: fix model/service mismatches, dispatch categorization after Plaid sync, and verify the question flow works.

Purpose: This is the core AI intelligence feature -- transactions must be automatically categorized by Claude with confidence-based routing, and users must be able to interact with AI-generated questions.

Output: Working categorization pipeline from Plaid sync through Claude API to question generation, plus working question answer flow.
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ai-intelligence-financial-features/03-RESEARCH.md
@app/Models/AIQuestion.php
@app/Services/AI/TransactionCategorizerService.php
@app/Jobs/CategorizePendingTransactions.php
@app/Http/Controllers/Api/PlaidController.php
@app/Http/Controllers/Api/AIQuestionController.php
@routes/console.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix AIQuestion model and wire categorization dispatch into PlaidController</name>
  <files>
    app/Models/AIQuestion.php
    app/Http/Controllers/Api/PlaidController.php
  </files>
  <action>
**AIQuestion model ($fillable mismatch fix):**

The DB schema (migration 000001) has columns: `ai_confidence` (decimal 3,2) and `ai_best_guess` (string nullable). The `TransactionCategorizerService.processCategorizationResults()` writes `ai_confidence` and `ai_best_guess` via `AIQuestion::create()`. But the model's $fillable only has `confidence` -- which doesn't match the DB column name.

Fix `app/Models/AIQuestion.php`:
1. Change `confidence` to `ai_confidence` in $fillable array
2. Add `ai_best_guess` to $fillable array
3. Update the casts array: change `'confidence' => 'decimal:2'` to `'ai_confidence' => 'decimal:2'`

The final $fillable should be:
```
'user_id', 'transaction_id', 'question', 'options', 'question_type',
'ai_confidence', 'ai_best_guess', 'user_answer', 'status', 'answered_at',
```

**PlaidController sync dispatch:**

Read `app/Http/Controllers/Api/PlaidController.php`. After the sync operation completes successfully in the `sync()` method, add a dispatch of `CategorizePendingTransactions` job:

```php
use App\Jobs\CategorizePendingTransactions;

// After successful sync, in the sync() method, before returning response:
CategorizePendingTransactions::dispatch(auth()->id());
```

Add the import at the top of the file. The dispatch should happen AFTER the sync loop completes (not inside it), so categorization runs once after all connections are synced.

Do NOT modify the CategorizePendingTransactions job itself or the TransactionCategorizerService -- they are already correct and work together properly. The service writes `ai_confidence` which now matches the fixed model $fillable.
  </action>
  <verify>
Run `php artisan about` to confirm no boot errors. Then verify the model change:
```bash
php artisan tinker --execute="echo implode(', ', (new \App\Models\AIQuestion)->getFillable());"
```
Should show `ai_confidence` and `ai_best_guess` in the output. Also verify PlaidController has the dispatch:
```bash
grep -n "CategorizePendingTransactions" app/Http/Controllers/Api/PlaidController.php
```
  </verify>
  <done>AIQuestion model $fillable matches DB schema columns (ai_confidence, ai_best_guess). PlaidController::sync() dispatches CategorizePendingTransactions after successful sync. Application boots without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Verify question expiry schedule and validate end-to-end pipeline with route smoke test</name>
  <files>
    routes/console.php
  </files>
  <action>
**Verify question expiry is active:**

Read `routes/console.php`. The question expiry schedule should already be active (uncommented). Confirm it exists and runs daily at 03:00, expiring questions with status 'pending' older than 7 days. If it's commented out, uncomment it. Per the current code analysis it IS already active -- just verify and move on.

**Verify subscription detection schedule is ready to enable:**

The subscription detection schedule in console.php is currently commented out with a TODO referencing an artisan command. Since `SubscriptionDetectorService` is already called directly from `CategorizePendingTransactions` job (the job calls `$subDetector->detectSubscriptions($this->userId)` after categorization), subscription detection is ALREADY wired into the categorization pipeline. The scheduled task is a secondary trigger.

Replace the commented-out subscription detection artisan command reference with a direct Schedule::call that invokes the service, similar to how categorize-pending is done:

```php
// ── Detect subscriptions (daily at 2am) ──
Schedule::call(function () {
    $detector = app(\App\Services\SubscriptionDetectorService::class);
    \App\Models\User::whereHas('bankConnections')->each(function ($user) use ($detector) {
        $detector->detectSubscriptions($user->id);
    });
})->dailyAt('02:00')->name('detect-subscriptions');
```

Add the necessary `use` imports at the top of console.php if not already present:
- `use App\Services\SubscriptionDetectorService;` (only if using the class directly without FQCN)

**Validate end-to-end pipeline:**

Run `php artisan route:list --path=api/v1/questions` to verify question routes exist.
Run `php artisan route:list --path=api/v1/transactions` to verify transaction routes exist.
Run `php artisan schedule:list` to verify the scheduled tasks are registered (categorize-pending, expire-ai-questions, detect-subscriptions).
  </action>
  <verify>
```bash
php artisan schedule:list
```
Should show at least 3 scheduled tasks: categorize-pending (every 2 hours), expire-ai-questions (daily at 03:00), detect-subscriptions (daily at 02:00).

```bash
php artisan route:list --path=api/v1/questions
```
Should show GET /api/v1/questions, POST /api/v1/questions/{question}/answer, POST /api/v1/questions/bulk-answer.
  </verify>
  <done>Question expiry runs daily. Subscription detection runs daily at 02:00. All question and transaction routes are registered. The full pipeline is: Plaid sync -> CategorizePendingTransactions dispatch -> TransactionCategorizerService batches to Claude -> confidence routing creates AIQuestions for uncertain ones -> user answers via AIQuestionController -> handleUserAnswer updates transaction. Schedule handles expiry and background subscription detection.</done>
</task>

</tasks>

<verification>
1. `php artisan about` boots without errors
2. AIQuestion model $fillable includes `ai_confidence` and `ai_best_guess` (matching DB schema and service writes)
3. PlaidController::sync() dispatches CategorizePendingTransactions
4. `php artisan schedule:list` shows categorize-pending, expire-ai-questions, detect-subscriptions
5. Question routes all resolve correctly
6. No broken imports or class references
</verification>

<success_criteria>
- TransactionCategorizerService can create AIQuestion records without MassAssignmentException (ai_confidence and ai_best_guess are in $fillable)
- Plaid sync triggers categorization automatically
- Subscription detection runs on schedule
- Question expiry runs on schedule
- All AI question controller routes resolve to correct methods
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-intelligence-financial-features/03-01-SUMMARY.md`
</output>
