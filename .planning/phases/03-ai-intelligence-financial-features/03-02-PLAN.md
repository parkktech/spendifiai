---
phase: 03-ai-intelligence-financial-features
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Models/SavingsPlanAction.php
  - app/Models/SavingsRecommendation.php
  - app/Services/AI/SavingsAnalyzerService.php
  - database/migrations/2026_02_10_000008_add_missing_savings_recommendation_columns.php
  - routes/console.php
autonomous: true

must_haves:
  truths:
    - "System detects recurring subscriptions from transaction patterns and flags unused ones"
    - "User can trigger savings analysis and view AI-generated recommendations with action steps and related merchants"
    - "User can dismiss or apply recommendations"
    - "User can set savings targets and get AI-generated action plans with concrete steps"
    - "User can accept/reject plan actions and track progress with pulse checks"
    - "Savings analysis runs weekly on schedule"
  artifacts:
    - path: "app/Models/SavingsPlanAction.php"
      provides: "SavingsPlanAction model with complete $fillable matching all 21+ DB columns"
      contains: "how_to"
    - path: "app/Models/SavingsRecommendation.php"
      provides: "SavingsRecommendation model with action_steps and related_merchants"
      contains: "action_steps"
    - path: "app/Services/AI/SavingsAnalyzerService.php"
      provides: "SavingsAnalyzerService that saves action_steps and related_merchants from Claude response"
      contains: "action_steps"
    - path: "database/migrations/2026_02_10_000008_add_missing_savings_recommendation_columns.php"
      provides: "Migration adding action_steps and related_merchants columns to savings_recommendations"
  key_links:
    - from: "app/Services/AI/SavingsAnalyzerService.php"
      to: "app/Models/SavingsRecommendation.php"
      via: "SavingsRecommendation::create with all Claude response fields"
      pattern: "SavingsRecommendation::create"
    - from: "app/Services/AI/SavingsTargetPlannerService.php"
      to: "app/Models/SavingsPlanAction.php"
      via: "SavingsPlanAction::create with all plan action fields"
      pattern: "SavingsPlanAction::create"
    - from: "app/Http/Controllers/Api/SavingsController.php"
      to: "app/Services/AI/SavingsAnalyzerService.php"
      via: "analyze() method call"
      pattern: "analyzer->analyze"
---

<objective>
Fix savings model $fillable mismatches, add missing DB columns, update service to save all Claude response fields, and enable savings analysis schedule.

Purpose: The savings and subscription features are core financial intelligence. All service logic exists but models are missing fields that will cause MassAssignmentException, and the savings_recommendations table is missing columns the model expects.

Output: Working savings pipeline where analysis saves all fields, plan actions save all fields, and scheduled tasks run.
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ai-intelligence-financial-features/03-RESEARCH.md
@app/Models/SavingsPlanAction.php
@app/Models/SavingsRecommendation.php
@app/Services/AI/SavingsAnalyzerService.php
@app/Services/AI/SavingsTargetPlannerService.php
@app/Http/Controllers/Api/SavingsController.php
@database/migrations/2026_02_10_000003_create_savings_targets.php
@database/migrations/2026_02_10_000001_create_spendwise_tables.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix SavingsPlanAction $fillable, add SavingsRecommendation migration, and update models</name>
  <files>
    app/Models/SavingsPlanAction.php
    app/Models/SavingsRecommendation.php
    database/migrations/2026_02_10_000008_add_missing_savings_recommendation_columns.php
  </files>
  <action>
**Fix SavingsPlanAction model (CRITICAL -- very incomplete $fillable):**

The DB schema (migration 000003) has these columns that the `SavingsTargetPlannerService.storePlanActions()` writes but the model's $fillable is missing:

Missing from $fillable: `user_id`, `how_to`, `impact`, `priority`, `is_essential_cut`, `related_merchants`, `related_subscription_ids`, `accepted_at`, `rejected_at`, `rejection_reason`

The SavingsController.respondToAction() also writes `accepted_at`, `rejected_at`, `rejection_reason`.

Update `app/Models/SavingsPlanAction.php` $fillable to include ALL columns from the DB schema:

```php
protected $fillable = [
    'user_id', 'savings_target_id', 'title', 'description', 'how_to',
    'monthly_savings', 'current_spending', 'recommended_spending', 'category',
    'difficulty', 'impact', 'priority', 'is_essential_cut',
    'related_merchants', 'related_subscription_ids',
    'status', 'user_response', 'accepted_at', 'rejected_at', 'rejection_reason',
];
```

Add casts for the JSON and boolean/datetime fields:
```php
protected function casts(): array
{
    return [
        'current_spending' => 'decimal:2',
        'recommended_spending' => 'decimal:2',
        'monthly_savings' => 'decimal:2',
        'is_essential_cut' => 'boolean',
        'related_merchants' => 'array',
        'related_subscription_ids' => 'array',
        'accepted_at' => 'datetime',
        'rejected_at' => 'datetime',
    ];
}
```

**Create migration for missing savings_recommendations columns:**

The `savings_recommendations` table is missing `action_steps` and `related_merchants` columns. The model has them in $fillable with 'array' casts, and the Claude prompt returns both fields, but the DB table doesn't have the columns.

Create `database/migrations/2026_02_10_000008_add_missing_savings_recommendation_columns.php`:

```php
<?php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('savings_recommendations', function (Blueprint $table) {
            $table->text('action_steps')->nullable()->after('impact');
            $table->text('related_merchants')->nullable()->after('action_steps');
        });
    }

    public function down(): void
    {
        Schema::table('savings_recommendations', function (Blueprint $table) {
            $table->dropColumn(['action_steps', 'related_merchants']);
        });
    }
};
```

Use TEXT columns (not JSON) because SavingsRecommendation model casts them as 'array' -- Laravel's array cast works with TEXT. This also aligns with the encryption convention (TEXT for anything that might be sensitive later), though these particular fields don't need encryption.

**Update SavingsRecommendation model:**

The model $fillable and casts look correct already (`action_steps` and `related_merchants` in $fillable with 'array' casts). Just verify and add `generated_at`, `applied_at`, `dismissed_at` to $fillable if missing, since the controller writes `dismissed_at` and `applied_at`, and the service writes `generated_at`. Check the current $fillable:

Current: `'user_id','title','description','monthly_savings','annual_savings','difficulty','impact','category','status','action_steps','related_merchants'`

Add missing: `'generated_at', 'applied_at', 'dismissed_at'`

Add datetime casts:
```php
protected function casts(): array
{
    return [
        'monthly_savings' => 'decimal:2',
        'annual_savings' => 'decimal:2',
        'action_steps' => 'array',
        'related_merchants' => 'array',
        'generated_at' => 'datetime',
        'applied_at' => 'datetime',
        'dismissed_at' => 'datetime',
    ];
}
```

Run `php artisan migrate` to apply the new migration.
  </action>
  <verify>
```bash
php artisan migrate
```
Should run the new migration without errors.

```bash
php artisan tinker --execute="echo implode(', ', (new \App\Models\SavingsPlanAction)->getFillable());"
```
Should show all 21 fields including `user_id`, `how_to`, `impact`, `priority`, `is_essential_cut`, `related_merchants`, `related_subscription_ids`, `accepted_at`, `rejected_at`, `rejection_reason`.

```bash
php artisan tinker --execute="echo implode(', ', (new \App\Models\SavingsRecommendation)->getFillable());"
```
Should show `action_steps`, `related_merchants`, `generated_at`, `applied_at`, `dismissed_at`.
  </verify>
  <done>SavingsPlanAction $fillable has all 21 fields matching DB schema. SavingsRecommendation has action_steps and related_merchants columns in DB. Both models have complete casts. Migration applied successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Update SavingsAnalyzerService to save all Claude fields and enable savings schedule</name>
  <files>
    app/Services/AI/SavingsAnalyzerService.php
    routes/console.php
  </files>
  <action>
**Fix SavingsAnalyzerService.storeRecommendations():**

Read `app/Services/AI/SavingsAnalyzerService.php`. The `storeRecommendations()` method creates SavingsRecommendation records but does NOT save `action_steps` or `related_merchants` from the Claude response, even though the Claude prompt explicitly returns both fields.

Update the `SavingsRecommendation::create()` call in `storeRecommendations()` to include:
```php
SavingsRecommendation::create([
    'user_id'            => $userId,
    'title'              => $rec['title'],
    'description'        => $rec['description'],
    'monthly_savings'    => $rec['monthly_savings'],
    'annual_savings'     => $rec['annual_savings'],
    'difficulty'         => $rec['difficulty'],
    'category'           => $rec['category'],
    'impact'             => $rec['impact'],
    'action_steps'       => $rec['action_steps'] ?? null,
    'related_merchants'  => $rec['related_merchants'] ?? null,
    'generated_at'       => now(),
]);
```

The key additions are `action_steps`, `related_merchants` (from Claude response), and the existing `impact` field.

**Enable savings analysis schedule in console.php:**

Read `routes/console.php`. The savings analysis schedule is commented out with a TODO. Replace the commented-out command-based schedule with a direct Schedule::call that invokes the service:

```php
// ── Generate savings recommendations (weekly on Mondays) ──
Schedule::call(function () {
    $analyzer = app(\App\Services\AI\SavingsAnalyzerService::class);
    \App\Models\User::whereHas('bankConnections')->each(function ($user) use ($analyzer) {
        $analyzer->analyze($user);
    });
})->weeklyOn(1, '06:00')->name('generate-savings-recommendations');
```

NOTE: If Plan 03-01 already modified console.php (to enable subscription detection), make sure to read the current file state first and add this schedule alongside the existing ones. Do not duplicate the subscription detection schedule from Plan 03-01.

Add the import `use App\Services\AI\SavingsAnalyzerService;` at the top if not already present.
  </action>
  <verify>
```bash
grep -n "action_steps\|related_merchants" app/Services/AI/SavingsAnalyzerService.php
```
Should show the two new fields in the create call.

```bash
php artisan schedule:list
```
Should show generate-savings-recommendations running weekly on Mondays at 06:00.

```bash
php artisan about
```
Should boot without errors.
  </verify>
  <done>SavingsAnalyzerService saves action_steps and related_merchants from Claude response. Savings analysis schedule runs weekly on Mondays at 06:00. All savings endpoints (recommendations, analyze, dismiss, apply, setTarget, getTarget, regeneratePlan, respondToAction, pulseCheck) work without MassAssignmentException.</done>
</task>

</tasks>

<verification>
1. `php artisan migrate` applies the new migration
2. `php artisan about` boots without errors
3. SavingsPlanAction $fillable has all 21 fields
4. SavingsRecommendation has action_steps and related_merchants in DB and model
5. SavingsAnalyzerService saves action_steps and related_merchants from Claude
6. `php artisan schedule:list` shows generate-savings-recommendations
7. All 10 savings routes resolve (check with `php artisan route:list --path=api/v1/savings`)
</verification>

<success_criteria>
- SavingsPlanAction::create() accepts all fields from SavingsTargetPlannerService.storePlanActions() without MassAssignmentException
- SavingsRecommendation::create() accepts action_steps and related_merchants without error
- Savings analysis schedule is active weekly
- Subscription detection schedule is active daily (wired in Plan 01)
- All savings controller endpoints resolve to correct methods
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-intelligence-financial-features/03-02-SUMMARY.md`
</output>
