---
phase: 04-events-notifications-frontend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Events/BankConnected.php
  - app/Events/TransactionsImported.php
  - app/Events/TransactionCategorized.php
  - app/Events/UserAnsweredQuestion.php
  - app/Listeners/TriggerInitialSync.php
  - app/Listeners/DispatchCategorizationJob.php
  - app/Listeners/UpdateSubscriptionDetection.php
  - app/Listeners/UpdateTransactionCategory.php
  - app/Listeners/CheckBudgetThresholds.php
  - app/Listeners/NotifyQuestionsReady.php
  - app/Jobs/SyncBankTransactions.php
  - app/Notifications/AIQuestionsReady.php
  - app/Notifications/UnusedSubscriptionAlert.php
  - app/Notifications/BudgetThresholdReached.php
  - app/Notifications/WeeklySavingsDigest.php
  - app/Http/Controllers/Api/PlaidController.php
  - app/Http/Controllers/Api/AIQuestionController.php
  - app/Jobs/CategorizePendingTransactions.php
  - routes/console.php
autonomous: true

must_haves:
  truths:
    - "Connecting a bank dispatches BankConnected event which triggers initial sync and categorization"
    - "Importing transactions dispatches TransactionsImported which triggers AI categorization"
    - "Categorizing transactions dispatches TransactionCategorized which triggers subscription detection"
    - "Answering an AI question dispatches UserAnsweredQuestion which updates the transaction category"
    - "Bank sync runs every 4 hours via SyncBankTransactions job for all active connections"
    - "User receives database+email notification when AI questions are ready"
    - "User receives notification when unused subscriptions are detected"
    - "User receives notification when budget threshold is reached"
    - "User receives weekly savings digest"
  artifacts:
    - path: "app/Events/BankConnected.php"
      provides: "Event dispatched after Plaid token exchange"
      contains: "class BankConnected"
    - path: "app/Events/TransactionsImported.php"
      provides: "Event dispatched after transaction sync"
      contains: "class TransactionsImported"
    - path: "app/Events/TransactionCategorized.php"
      provides: "Event dispatched after AI categorization"
      contains: "class TransactionCategorized"
    - path: "app/Events/UserAnsweredQuestion.php"
      provides: "Event dispatched after user answers question"
      contains: "class UserAnsweredQuestion"
    - path: "app/Listeners/TriggerInitialSync.php"
      provides: "Listener that dispatches SyncBankTransactions on BankConnected"
      contains: "SyncBankTransactions::dispatch"
    - path: "app/Listeners/DispatchCategorizationJob.php"
      provides: "Listener that dispatches CategorizePendingTransactions on TransactionsImported"
      contains: "CategorizePendingTransactions::dispatch"
    - path: "app/Jobs/SyncBankTransactions.php"
      provides: "Per-connection Plaid sync job"
      contains: "class SyncBankTransactions"
    - path: "app/Notifications/AIQuestionsReady.php"
      provides: "Database+email notification for new AI questions"
      contains: "class AIQuestionsReady"
    - path: "app/Notifications/WeeklySavingsDigest.php"
      provides: "Weekly savings email digest"
      contains: "class WeeklySavingsDigest"
  key_links:
    - from: "app/Http/Controllers/Api/PlaidController.php"
      to: "app/Events/BankConnected.php"
      via: "BankConnected::dispatch() in exchangeToken method"
      pattern: "BankConnected::dispatch"
    - from: "app/Listeners/TriggerInitialSync.php"
      to: "app/Jobs/SyncBankTransactions.php"
      via: "Dispatches SyncBankTransactions job"
      pattern: "SyncBankTransactions::dispatch"
    - from: "routes/console.php"
      to: "app/Jobs/SyncBankTransactions.php"
      via: "Scheduled every 4 hours"
      pattern: "SyncBankTransactions::dispatch"
---

<objective>
Build the event-driven architecture (4 events, 6 listeners), create the SyncBankTransactions job, build 4 notification classes, and wire event dispatching into existing controllers and jobs.

Purpose: Connect all backend features via Laravel events so that bank connections automatically trigger syncs, syncs trigger categorization, categorization triggers subscription detection, and users receive notifications at each stage.

Output: 4 event classes, 6 listener classes, 1 new job, 4 notification classes, updated controllers/jobs with event dispatches, updated console.php schedule.
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-events-notifications-frontend/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create events, listeners, SyncBankTransactions job, and wire event chain</name>
  <files>
    app/Events/BankConnected.php
    app/Events/TransactionsImported.php
    app/Events/TransactionCategorized.php
    app/Events/UserAnsweredQuestion.php
    app/Listeners/TriggerInitialSync.php
    app/Listeners/DispatchCategorizationJob.php
    app/Listeners/UpdateSubscriptionDetection.php
    app/Listeners/UpdateTransactionCategory.php
    app/Listeners/CheckBudgetThresholds.php
    app/Listeners/NotifyQuestionsReady.php
    app/Jobs/SyncBankTransactions.php
    app/Http/Controllers/Api/PlaidController.php
    app/Http/Controllers/Api/AIQuestionController.php
    app/Jobs/CategorizePendingTransactions.php
    routes/console.php
  </files>
  <action>
    Create 4 Laravel event classes:

    1. **BankConnected** (`app/Events/BankConnected.php`):
       - Constructor: `public readonly BankConnection $connection, public readonly User $user`
       - Uses: Dispatchable, InteractsWithSockets, SerializesModels
       - Does NOT implement ShouldBroadcast (no real-time needed)

    2. **TransactionsImported** (`app/Events/TransactionsImported.php`):
       - Constructor: `public readonly BankConnection $connection, public readonly int $count`
       - Same traits as above

    3. **TransactionCategorized** (`app/Events/TransactionCategorized.php`):
       - Constructor: `public readonly User $user, public readonly int $categorizedCount, public readonly int $questionsCreated`
       - Same traits

    4. **UserAnsweredQuestion** (`app/Events/UserAnsweredQuestion.php`):
       - Constructor: `public readonly AIQuestion $question, public readonly User $user`
       - Same traits

    Create 6 listener classes (all implement ShouldQueue):

    1. **TriggerInitialSync** (handles BankConnected):
       - Dispatches `SyncBankTransactions::dispatch($event->connection)`

    2. **DispatchCategorizationJob** (handles TransactionsImported):
       - Gets user_id from `$event->connection->user_id`
       - Dispatches `CategorizePendingTransactions::dispatch($userId)`

    3. **UpdateSubscriptionDetection** (handles TransactionCategorized):
       - Uses `app(SubscriptionDetectorService::class)` to run detection for `$event->user->id`

    4. **UpdateTransactionCategory** (handles UserAnsweredQuestion):
       - Gets the question's transaction, updates `user_category` to the answer, sets `review_status` to `'confirmed'`
       - Note: Check AIQuestionController to see if it already does this inline. If so, this listener should handle just the event dispatch side effects (like triggering re-categorization or subscription detection), NOT duplicate the update.

    5. **CheckBudgetThresholds** (handles TransactionCategorized):
       - After categorization, check the user's BudgetGoal models for the categorized categories
       - Sum spending for current month per category, compare to budget goal amount
       - If spending >= alert_threshold% of goal, dispatch BudgetThresholdReached notification
       - If spending >= 100% of goal, dispatch with exceeded=true

    6. **NotifyQuestionsReady** (handles TransactionCategorized):
       - If `$event->questionsCreated > 0`, send AIQuestionsReady notification to the user

    Create **SyncBankTransactions** job (`app/Jobs/SyncBankTransactions.php`):
    - Constructor: `public BankConnection $connection`
    - Implements ShouldQueue, uses InteractsWithQueue, Queueable, Dispatchable, SerializesModels
    - `$tries = 3`, `$backoff = [60, 300, 900]` (retry with escalating backoff)
    - In `handle(PlaidService $plaidService)`:
      - Call `$plaidService->syncTransactions($this->connection)`
      - If result has `added > 0`, dispatch `TransactionsImported::dispatch($this->connection, $result['added'])`
      - If sync fails (PlaidService throws), catch and update connection status to error

    Wire event dispatches into existing code:

    1. **PlaidController::exchangeToken()** — After successful token exchange (after creating BankConnection), add: `BankConnected::dispatch($connection, $request->user())`

    2. **AIQuestionController::answerQuestion()** — After successfully answering, add: `UserAnsweredQuestion::dispatch($question, $request->user())`
       - Also wire into `bulkAnswer()` method — dispatch for each answered question

    3. **CategorizePendingTransactions job** — At the end of the handle() method, after categorization completes:
       - Count how many transactions were categorized and how many questions were created
       - Dispatch `TransactionCategorized::dispatch($user, $categorizedCount, $questionsCreated)`

    4. **routes/console.php** — Uncomment the SyncBankTransactions schedule block:
       - Remove the `use` comment for SyncBankTransactions
       - Uncomment the `Schedule::call` block for sync-bank-transactions
       - Also add a weekly savings digest dispatch (Monday 07:00, after savings analysis at 06:00):
         ```php
         Schedule::call(function () {
             User::whereHas('savingsRecommendations')->each(function ($user) {
                 $user->notify(new \App\Notifications\WeeklySavingsDigest($user));
             });
         })->weeklyOn(1, '07:00')->name('weekly-savings-digest');
         ```
       - Add notification dispatch after subscription detection schedule:
         After the detect-subscriptions Schedule::call, add a new schedule or modify the existing one to dispatch UnusedSubscriptionAlert for users who have unused subscriptions detected

    Laravel event auto-discovery: No EventServiceProvider needed. Laravel 12 auto-discovers listeners by their type-hinted `handle()` method parameter. Just create the classes.

    IMPORTANT: Keep event chains unidirectional to avoid circular dispatches. BankConnected -> TransactionsImported -> TransactionCategorized. Never dispatch backwards.
  </action>
  <verify>
    Run `php artisan event:list` to verify events are discovered with their listeners.
    Run `php artisan route:list --path=api` to confirm no route regressions.
    Verify SyncBankTransactions job exists: `php artisan tinker --execute="new \App\Jobs\SyncBankTransactions(new \App\Models\BankConnection())"`
    Verify no syntax errors: `php -l app/Events/*.php app/Listeners/*.php app/Jobs/SyncBankTransactions.php app/Notifications/*.php`
  </verify>
  <done>
    4 events discovered, 6 listeners mapped to events, SyncBankTransactions job dispatchable, PlaidController dispatches BankConnected, CategorizePendingTransactions dispatches TransactionCategorized, console.php has bank sync schedule uncommented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create 4 notification classes and run notifications migration</name>
  <files>
    app/Notifications/AIQuestionsReady.php
    app/Notifications/UnusedSubscriptionAlert.php
    app/Notifications/BudgetThresholdReached.php
    app/Notifications/WeeklySavingsDigest.php
  </files>
  <action>
    First, run `php artisan migrate` to ensure the notifications table exists (migration was created in research phase).

    Create 4 notification classes, all using `Queueable` trait and delivering via `['database', 'mail']` channels:

    1. **AIQuestionsReady** (`app/Notifications/AIQuestionsReady.php`):
       - Constructor: `public readonly int $questionCount`
       - `via()`: returns `['database', 'mail']`
       - `toMail()`: Subject "{count} transactions need your input", line "AI has categorized some transactions but needs your help to confirm.", action button "Review Questions" linking to `/questions`
       - `toArray()`: `['type' => 'ai_questions_ready', 'count' => $this->questionCount, 'message' => "{count} transactions need your review"]`

    2. **UnusedSubscriptionAlert** (`app/Notifications/UnusedSubscriptionAlert.php`):
       - Constructor: `public readonly array $subscriptions, public readonly float $totalMonthlyCost`
       - `via()`: `['database', 'mail']`
       - `toMail()`: Subject "You may have {count} unused subscriptions", line listing subscription names and total monthly cost, action "Review Subscriptions" linking to `/subscriptions`
       - `toArray()`: `['type' => 'unused_subscriptions', 'count' => count($this->subscriptions), 'monthly_cost' => $this->totalMonthlyCost, 'subscriptions' => $this->subscriptions]`

    3. **BudgetThresholdReached** (`app/Notifications/BudgetThresholdReached.php`):
       - Constructor: `public readonly string $category, public readonly float $spent, public readonly float $budget, public readonly bool $exceeded = false`
       - `via()`: `['database', 'mail']`
       - `toMail()`: If exceeded: "You've exceeded your {category} budget", else "You've reached {pct}% of your {category} budget". Action "View Budget" linking to `/dashboard`
       - `toArray()`: `['type' => 'budget_threshold', 'category' => $this->category, 'spent' => $this->spent, 'budget' => $this->budget, 'exceeded' => $this->exceeded, 'percentage' => round(($this->spent / $this->budget) * 100)]`

    4. **WeeklySavingsDigest** (`app/Notifications/WeeklySavingsDigest.php`):
       - Constructor: `public readonly User $targetUser` (the user to generate digest for)
       - `via()`: `['database', 'mail']`
       - In `toMail()`: Query user's savings recommendations from the past week, savings target progress, and format a weekly summary email. Subject: "Your Weekly Savings Summary". Include total potential savings, active recommendations count, target progress percentage.
       - `toArray()`: `['type' => 'weekly_savings_digest', 'recommendations_count' => $count, 'potential_savings' => $amount]`

    All notifications should:
    - Use `Illuminate\Notifications\Notification` as base class
    - Import `Illuminate\Bus\Queueable` and `use Queueable` in class body
    - Import and use `Illuminate\Notifications\Messages\MailMessage` for toMail
    - Have a proper `__construct` with readonly properties
  </action>
  <verify>
    Run `php -l app/Notifications/*.php` to verify no syntax errors.
    Run `php artisan migrate --pretend` or `php artisan migrate` to verify notifications table is ready.
    Verify classes are loadable: `php artisan tinker --execute="new \App\Notifications\AIQuestionsReady(5)"`
  </verify>
  <done>
    4 notification classes created with database+mail channels. Notifications table migrated. All classes instantiable without errors.
  </done>
</task>

</tasks>

<verification>
1. `php artisan event:list` shows all 4 events with their listeners mapped
2. `php -l app/Events/*.php app/Listeners/*.php app/Jobs/SyncBankTransactions.php app/Notifications/*.php` — no syntax errors
3. `grep -r "BankConnected::dispatch" app/Http/Controllers/Api/PlaidController.php` confirms event dispatch wired
4. `grep -r "TransactionCategorized::dispatch" app/Jobs/CategorizePendingTransactions.php` confirms event dispatch wired
5. `grep -r "SyncBankTransactions::dispatch" routes/console.php` confirms schedule uncommented
6. `php artisan migrate` runs successfully (notifications table)
7. No circular event chains (BankConnected -> TransactionsImported -> TransactionCategorized, one-way)
</verification>

<success_criteria>
- 4 event classes, 6 listener classes, 1 job, 4 notifications created
- Event chain: BankConnected -> TriggerInitialSync -> SyncBankTransactions -> TransactionsImported -> CategorizePendingTransactions -> TransactionCategorized -> UpdateSubscriptionDetection + CheckBudgetThresholds + NotifyQuestionsReady
- SyncBankTransactions scheduled every 4 hours
- Weekly savings digest scheduled Monday 07:00
- All existing tests still pass (if any)
- No syntax errors in any new file
</success_criteria>

<output>
After completion, create `.planning/phases/04-events-notifications-frontend/04-01-SUMMARY.md`
</output>
