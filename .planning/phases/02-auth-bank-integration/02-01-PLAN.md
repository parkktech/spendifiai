---
phase: 02-auth-bank-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Models/User.php
  - app/Http/Controllers/Auth/AuthController.php
  - app/Http/Controllers/Auth/SocialAuthController.php
  - app/Http/Controllers/Auth/TwoFactorController.php
  - app/Http/Controllers/Auth/PasswordResetController.php
  - app/Http/Controllers/Auth/EmailVerificationController.php
  - routes/api.php
autonomous: true

must_haves:
  truths:
    - "User can register with email/password and receives a Sanctum bearer token"
    - "User login checks account lockout, increments failed attempts, and locks after 5 failures"
    - "User login resets failed_login_attempts on success"
    - "User with 2FA enabled is prompted for TOTP code on login"
    - "User can enable 2FA (get QR code), confirm with TOTP code, disable 2FA, and regenerate recovery codes"
    - "User can log in via Google OAuth and receives token via URL fragment redirect"
    - "User can disconnect Google account only if they have a password set"
    - "User can reset password via email link and change password while logged in"
    - "Email verification resend endpoint works under auth:sanctum"
    - "Auth endpoints have rate limiting applied"
  artifacts:
    - path: "app/Models/User.php"
      provides: "User model with complete $fillable including lockout and 2FA fields"
      contains: "failed_login_attempts"
    - path: "app/Http/Controllers/Auth/AuthController.php"
      provides: "Register, login (with lockout + 2FA), logout, me endpoints"
      exports: ["register", "login", "logout", "me"]
    - path: "app/Http/Controllers/Auth/TwoFactorController.php"
      provides: "2FA enable/confirm/disable/regenerate endpoints"
      exports: ["status", "enable", "confirm", "disable", "regenerateRecoveryCodes"]
    - path: "app/Http/Controllers/Auth/SocialAuthController.php"
      provides: "Google OAuth redirect, callback, disconnect"
      exports: ["redirectToGoogle", "handleGoogleCallback", "disconnectGoogle"]
  key_links:
    - from: "app/Http/Controllers/Auth/AuthController.php"
      to: "app/Models/User.php"
      via: "update() calls for lockout fields"
      pattern: "update.*locked_until|failed_login_attempts"
    - from: "app/Http/Controllers/Auth/TwoFactorController.php"
      to: "app/Models/User.php"
      via: "update() calls for 2FA fields"
      pattern: "update.*two_factor_secret|two_factor_confirmed_at"
---

<objective>
Fix critical bugs in the authentication system and verify all auth flows work correctly.

Purpose: The auth controllers (AuthController, TwoFactorController, SocialAuthController, PasswordResetController, EmailVerificationController) already exist with complete logic, but the User model is missing critical `$fillable` entries that will cause silent data loss on `update()` calls. This plan fixes those bugs and verifies end-to-end auth correctness.

Output: A fully functional authentication system where register, login (with lockout + 2FA), Google OAuth, password reset/change, email verification, and 2FA management all work correctly.
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auth-bank-integration/02-RESEARCH.md

@app/Models/User.php
@app/Http/Controllers/Auth/AuthController.php
@app/Http/Controllers/Auth/SocialAuthController.php
@app/Http/Controllers/Auth/TwoFactorController.php
@app/Http/Controllers/Auth/PasswordResetController.php
@app/Http/Controllers/Auth/EmailVerificationController.php
@routes/api.php
@routes/web.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix User model $fillable, casts, and $hidden for auth fields</name>
  <files>app/Models/User.php</files>
  <action>
The User model's `$fillable` array is missing fields that existing auth controllers call `->update()` on. Without these in `$fillable`, Eloquent silently ignores the values. This is the root cause of account lockout, 2FA, and several other features not working.

Add the following to User model `$fillable` array (keep existing entries, add these):
- `'failed_login_attempts'` -- used by AuthController::login() for lockout
- `'locked_until'` -- used by AuthController::login() for lockout
- `'two_factor_secret'` -- used by TwoFactorController::enable()
- `'two_factor_recovery_codes'` -- used by TwoFactorController::confirm()
- `'two_factor_confirmed_at'` -- used by TwoFactorController::confirm()

Add to `casts()` method (if not already present):
- `'locked_until' => 'datetime'` -- AuthController checks `$user->locked_until->isFuture()`

Verify `$hidden` already contains `'two_factor_secret'` and `'two_factor_recovery_codes'` (it does -- just confirm, do NOT remove).

Do NOT modify any relationships, helper methods, or other model behavior. Only touch `$fillable` and `casts()`.
  </action>
  <verify>
Run `php artisan tinker --execute="echo implode(',', (new \App\Models\User)->getFillable());"` and confirm output contains: `failed_login_attempts`, `locked_until`, `two_factor_secret`, `two_factor_recovery_codes`, `two_factor_confirmed_at`.

Run `php artisan tinker --execute="echo json_encode((new \App\Models\User)->getCasts());"` and confirm `locked_until` maps to `datetime`.

Run `php artisan serve --port=8099 &` then `curl -s http://localhost:8099/up` returns 200 (app boots without errors). Kill the server after.
  </verify>
  <done>User model $fillable contains all 11 fields (6 original + 5 added). Casts include locked_until as datetime. Application boots without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add rate limiting to auth routes and verify email verification route</name>
  <files>routes/api.php</files>
  <action>
The auth routes need rate limiting per AUTH-15 and the email verification API route is missing.

1. **Rate limiting on login route** -- Already has `throttle:10,1`. Verify and keep.

2. **Rate limiting on register route** -- Already has `throttle:5,1`. Verify and keep.

3. **Rate limiting on forgot-password** -- Already has `throttle:3,1`. Verify and keep.

4. **Add email verification route for API**: The `EmailVerificationController::verify()` method exists but has no API route. The Breeze web route handles browser verification links, which is correct for the SPA flow. However, add an API-accessible verification route for completeness:

Inside the authenticated `auth` prefix group (where `resend` already lives), add:
```php
Route::get('/email/verify/{id}/{hash}', [EmailVerificationController::class, 'verify'])
    ->middleware(['signed'])
    ->name('api.verification.verify');
```

This gives the SPA an API route to verify emails if needed, while the Breeze web route continues to handle the email link redirect.

5. **Add webhook route outside auth middleware**: Add BEFORE the `Route::middleware(['auth:sanctum'])` group:
```php
// Plaid Webhooks (no auth required -- verified by Plaid JWT signature)
Route::post('/v1/webhooks/plaid', [\App\Http\Controllers\Api\PlaidWebhookController::class, 'handle']);
```

Note: The PlaidWebhookController does not exist yet (created in Plan 03), but registering the route now ensures the route file is complete. If the route causes a class-not-found error during verification, that is acceptable -- Plan 03 will create the controller.

6. **Add rate limiting to change-password**: The `changePassword` route currently has no throttle. Add `->middleware('throttle:5,1')` to it:
```php
Route::post('/change-password', [PasswordResetController::class, 'changePassword'])
    ->middleware('throttle:5,1');
```

Do NOT modify any non-auth routes. Do NOT change the route structure or middleware groups.
  </action>
  <verify>
Run `php artisan route:list --path=api/auth` and confirm:
- POST api/auth/register has throttle middleware
- POST api/auth/login has throttle middleware
- POST api/auth/forgot-password has throttle middleware
- POST api/auth/change-password has throttle middleware
- GET api/auth/email/verify/{id}/{hash} exists with signed middleware
- POST api/auth/email/resend exists

Run `php artisan route:list --path=api/v1/webhooks` and confirm POST api/v1/webhooks/plaid exists (will show even if controller class doesn't exist yet -- route registration is separate from class loading in route:list).
  </verify>
  <done>All auth routes have rate limiting. Email verification API route registered. Webhook route registered (controller created in Plan 03). Change-password route has throttle:5,1.</done>
</task>

<task type="auto">
  <name>Task 3: Verify auth controller logic is correct end-to-end</name>
  <files>
    app/Http/Controllers/Auth/AuthController.php
    app/Http/Controllers/Auth/SocialAuthController.php
    app/Http/Controllers/Auth/TwoFactorController.php
    app/Http/Controllers/Auth/PasswordResetController.php
    app/Http/Controllers/Auth/EmailVerificationController.php
  </files>
  <action>
All 5 auth controllers already have complete logic from Phase 1. This task verifies correctness and fixes any remaining issues. Read each controller and verify:

**AuthController.php:**
- `register()`: Uses RegisterRequest, creates user, fires Registered event, returns token. CORRECT.
- `login()`: Checks lockout, verifies credentials, increments failed_login_attempts, checks 2FA, resets on success. CORRECT (now that User $fillable is fixed in Task 1).
- `logout()`: Revokes current token. CORRECT.
- `me()`: Returns user payload with profile. CORRECT.
- `verifyTwoFactorCode()`: Checks TOTP then recovery codes, removes used recovery code. CORRECT.
- No changes needed.

**SocialAuthController.php:**
- `redirectToGoogle()`: Returns URL as JSON for SPA or redirects for browser. CORRECT.
- `handleGoogleCallback()`: Finds/creates user, links Google, creates token, redirects with fragment. CORRECT.
- `disconnectGoogle()`: Checks password exists before allowing disconnect. CORRECT.
- No changes needed.

**TwoFactorController.php:**
- `enable()`: Has inline `$request->validate(['password' => 'required|current_password'])`. This violates CLAUDE.md convention but is a single-field check. Leave as-is for now -- creating a FormRequest for every inline validation is Phase 5 polish.
- `confirm()`: Inline validation for `code`. Same reasoning -- leave as-is.
- `disable()`: Inline validation for `password`. Same reasoning.
- `regenerateRecoveryCodes()`: Inline validation for `password`. Same reasoning.
- Logic is all correct -- QR generation, TOTP verification, recovery code generation all work.
- No changes needed.

**PasswordResetController.php:**
- `sendResetLink()`: Uses inline validation with captcha check. Always returns success (prevents email enumeration). CORRECT.
- `resetPassword()`: Uses Password::reset, forceFill with Hash::make, resets lockout fields, revokes tokens. CORRECT.
- `changePassword()`: Validates current_password, updates, revokes other tokens. CORRECT.
- No changes needed.

**EmailVerificationController.php:**
- `verify()`: Uses EmailVerificationRequest (Laravel's built-in signed URL handler). CORRECT.
- `resend()`: Sends verification notification. CORRECT.
- No changes needed.

**Summary:** After Task 1 fixes the User model, all auth controllers work correctly without code changes. This task is a verification-only task -- read each file and confirm no modifications are needed. If any issue IS found during reading, fix it. But based on research, none should be needed.
  </action>
  <verify>
Run `php artisan about` to confirm application boots without errors.

Test registration endpoint:
```bash
curl -s -X POST http://localhost:8099/api/auth/register \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{"name":"Test User","email":"test@example.com","password":"password123","password_confirmation":"password123"}' \
  | python3 -c "import sys,json; d=json.load(sys.stdin); assert 'token' in d, f'Missing token: {d}'; print('PASS: Registration returns token')"
```

Test login endpoint:
```bash
TOKEN=$(curl -s -X POST http://localhost:8099/api/auth/login \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{"email":"test@example.com","password":"password123"}' \
  | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('token',''))")

curl -s http://localhost:8099/api/auth/me \
  -H "Authorization: Bearer $TOKEN" \
  -H "Accept: application/json" \
  | python3 -c "import sys,json; d=json.load(sys.stdin); assert d['user']['email']=='test@example.com', f'Wrong user: {d}'; print('PASS: Me endpoint works')"
```

Test logout:
```bash
curl -s -X POST http://localhost:8099/api/auth/logout \
  -H "Authorization: Bearer $TOKEN" \
  -H "Accept: application/json" \
  | python3 -c "import sys,json; d=json.load(sys.stdin); assert 'Logged out' in d.get('message',''), f'Unexpected: {d}'; print('PASS: Logout works')"
```

Clean up test user via tinker:
```bash
php artisan tinker --execute="\App\Models\User::where('email','test@example.com')->first()?->delete();"
```
  </verify>
  <done>All 5 auth controllers verified correct. Register returns 201 with token. Login returns 200 with token. Me returns user data. Logout revokes token. No code changes needed beyond Task 1 model fix.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `php artisan about` -- application boots without errors
2. `php artisan route:list --path=api/auth` -- all auth routes visible with correct middleware
3. Registration, login, logout, and me endpoints all return expected JSON responses
4. User model $fillable includes all lockout and 2FA fields
5. Rate limiting middleware applied to all public auth endpoints
</verification>

<success_criteria>
- AUTH-01: Register endpoint creates user and returns token (201)
- AUTH-02: Registered event fires (triggers verification email)
- AUTH-03: Login endpoint returns bearer token
- AUTH-04: Token persists (me endpoint works with stored token)
- AUTH-05: Logout revokes token
- AUTH-06: Password reset link endpoint exists with throttle
- AUTH-07: Change password endpoint exists with throttle
- AUTH-08: Google OAuth redirect returns URL, callback creates token via fragment
- AUTH-09: Disconnect Google endpoint exists (requires password)
- AUTH-10: 2FA enable generates QR code and secret
- AUTH-11: Login checks 2FA code when enabled
- AUTH-12: 2FA disable endpoint exists (requires password)
- AUTH-13: Recovery codes regeneration endpoint exists
- AUTH-14: Account lockout after 5 failed attempts (User $fillable fixed)
- AUTH-15: Rate limiting on register, login, forgot-password, change-password
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-bank-integration/02-01-SUMMARY.md`
</output>
