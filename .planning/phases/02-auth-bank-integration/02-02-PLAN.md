---
phase: 02-auth-bank-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Models/BankConnection.php
  - app/Http/Controllers/Api/PlaidController.php
  - app/Http/Controllers/Api/BankAccountController.php
  - app/Services/PlaidService.php
  - database/migrations/2026_02_10_000006_add_error_columns_to_bank_connections.php
autonomous: true

must_haves:
  truths:
    - "User can create a Plaid Link token to start bank connection"
    - "User can exchange Plaid public token to establish persistent bank connection"
    - "System syncs transactions from connected bank using cursor-based sync"
    - "Sync cursor persists correctly between syncs (not re-fetching all transactions)"
    - "User can view connected bank accounts with balances"
    - "User can tag account purpose (personal/business/mixed/investment) and it cascades to transactions"
    - "User can disconnect a bank connection (revokes Plaid token + deletes connection)"
    - "Account balances are fetched from Plaid"
  artifacts:
    - path: "app/Models/BankConnection.php"
      provides: "BankConnection model with correct sync_cursor field and error columns"
      contains: "sync_cursor"
    - path: "app/Services/PlaidService.php"
      provides: "PlaidService with link token, exchange, sync, balances, disconnect"
      exports: ["createLinkToken", "exchangePublicToken", "syncTransactions", "getBalances", "disconnect"]
    - path: "app/Http/Controllers/Api/PlaidController.php"
      provides: "Plaid API endpoints"
      exports: ["createLinkToken", "exchangeToken", "sync", "disconnect"]
    - path: "app/Http/Controllers/Api/BankAccountController.php"
      provides: "Bank account listing and purpose management"
      exports: ["index", "updatePurpose"]
    - path: "database/migrations/2026_02_10_000006_add_error_columns_to_bank_connections.php"
      provides: "Migration adding error_code and error_message columns to bank_connections"
  key_links:
    - from: "app/Http/Controllers/Api/PlaidController.php"
      to: "app/Services/PlaidService.php"
      via: "constructor DI"
      pattern: "PlaidService.*plaidService"
    - from: "app/Services/PlaidService.php"
      to: "app/Models/BankConnection.php"
      via: "sync_cursor read/write"
      pattern: "sync_cursor"
    - from: "app/Http/Controllers/Api/BankAccountController.php"
      to: "app/Models/Transaction.php"
      via: "account_purpose cascade"
      pattern: "account_purpose.*newPurpose"
---

<objective>
Fix the BankConnection model naming mismatch, add missing database columns, and verify the Plaid integration flow works end-to-end.

Purpose: The BankConnection model references `plaid_cursor` in $fillable and $hidden, but the migration column and PlaidService both use `sync_cursor`. This mismatch causes the sync cursor to never persist, making every sync re-fetch ALL transactions. Additionally, the model references `error_code` and `error_message` columns that don't exist in any migration -- these need a new migration for the webhook handler (Plan 03) to set error state.

Output: A working Plaid integration where link tokens are created, public tokens are exchanged, transactions sync with persistent cursors, accounts show balances, purpose tagging cascades, and disconnection revokes Plaid tokens.
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auth-bank-integration/02-RESEARCH.md

@app/Models/BankConnection.php
@app/Services/PlaidService.php
@app/Http/Controllers/Api/PlaidController.php
@app/Http/Controllers/Api/BankAccountController.php
@database/migrations/2026_02_10_000001_create_spendwise_tables.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix BankConnection model and create migration for missing columns</name>
  <files>
    app/Models/BankConnection.php
    database/migrations/2026_02_10_000006_add_error_columns_to_bank_connections.php
  </files>
  <action>
**Fix BankConnection model $fillable and $hidden:**

The BankConnection model has `plaid_cursor` in both `$fillable` and `$hidden`, but the database column is `sync_cursor` (see migration 000001). The PlaidService correctly uses `$connection->sync_cursor` and `$connection->update(['sync_cursor' => $cursor])`. Fix:

1. In `$fillable`: Change `'plaid_cursor'` to `'sync_cursor'`
2. In `$hidden`: Change `'plaid_cursor'` to `'sync_cursor'`

Keep ALL other fields in $fillable and $hidden exactly as they are.

**Create migration for error_code and error_message columns:**

The BankConnection model's `$fillable` includes `'error_code'` and `'error_message'`, and `$hidden` includes them too, but NO migration creates these columns. The webhook handler (Plan 03) needs these columns to store error state when Plaid sends ITEM_LOGIN_REQUIRED or other error webhooks.

Create migration `database/migrations/2026_02_10_000006_add_error_columns_to_bank_connections.php`:
```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('bank_connections', function (Blueprint $table) {
            $table->string('error_code')->nullable()->after('sync_cursor');
            $table->text('error_message')->nullable()->after('error_code');
        });
    }

    public function down(): void
    {
        Schema::table('bank_connections', function (Blueprint $table) {
            $table->dropColumn(['error_code', 'error_message']);
        });
    }
};
```

Then run: `php artisan migrate`
  </action>
  <verify>
Run `php artisan migrate` -- should run the new migration successfully.

Verify column exists:
```bash
php artisan tinker --execute="echo Schema::hasColumn('bank_connections', 'error_code') ? 'YES' : 'NO';"
```
Should output `YES`.

Verify sync_cursor in model:
```bash
php artisan tinker --execute="echo in_array('sync_cursor', (new \App\Models\BankConnection)->getFillable()) ? 'YES' : 'NO';"
```
Should output `YES`.

Verify plaid_cursor is NOT in model:
```bash
php artisan tinker --execute="echo in_array('plaid_cursor', (new \App\Models\BankConnection)->getFillable()) ? 'BAD' : 'GOOD';"
```
Should output `GOOD`.
  </verify>
  <done>BankConnection model uses `sync_cursor` (matching the database column and PlaidService usage). Migration adds error_code and error_message columns to bank_connections table. `php artisan migrate` runs successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Verify PlaidController and PlaidService integration works correctly</name>
  <files>
    app/Http/Controllers/Api/PlaidController.php
    app/Services/PlaidService.php
    app/Http/Controllers/Api/BankAccountController.php
  </files>
  <action>
Read and verify the PlaidController, PlaidService, and BankAccountController work correctly. The research identified these components as functionally complete, but we need to verify after the BankConnection model fix.

**PlaidController.php -- verify:**
- `createLinkToken()`: Calls `$this->plaidService->createLinkToken(auth()->user())`. Returns `link_token` from response. CORRECT.
- `exchangeToken()`: Uses ExchangeTokenRequest, calls exchangePublicToken + syncTransactions + dispatches CategorizePendingTransactions. CORRECT.
- `sync()`: Finds active connection, syncs, dispatches categorization if added > 0. CORRECT. However, this only syncs the FIRST active connection. If user has multiple bank connections, only one syncs. This is acceptable for now -- users typically have one connection. Add a comment noting this limitation.
- `disconnect()`: Uses policy authorization, calls plaidService->disconnect(). CORRECT.

**PlaidService.php -- verify:**
- `createLinkToken()`: Includes webhook_url from config if set. CORRECT.
- `exchangePublicToken()`: Exchanges token, fetches institution details, syncs accounts. CORRECT.
- `syncTransactions()`: Uses cursor-based sync, processes added/modified/removed, saves cursor. CORRECT (now that sync_cursor is fixed in the model).
- `getBalances()`: Fetches and updates account balances. CORRECT.
- `disconnect()`: Calls removeItem, deactivates accounts, deletes connection. CORRECT.
- All Plaid API calls include client_id and secret via the `post()` helper. CORRECT.

**BankAccountController.php -- verify:**
- `index()`: Lists active accounts with connection info and purpose summary. CORRECT.
- `updatePurpose()`: Updates account purpose, bulk updates transaction.account_purpose, sets expense_type/tax_deductible based on purpose, dispatches re-categorization. CORRECT.

**Modifications needed:** None expected. If any minor issue is found during code reading, fix it. The primary value of this task is confirming everything integrates correctly after the sync_cursor fix.

Add a brief comment to PlaidController::sync() noting it syncs only the first active connection:
```php
// Note: Syncs only the first active connection. Multi-connection sync
// is handled by the webhook handler and scheduled tasks.
```
  </action>
  <verify>
Run `php artisan route:list --path=api/v1/plaid` and confirm all 4 Plaid routes exist:
- POST api/v1/plaid/link-token
- POST api/v1/plaid/exchange
- POST api/v1/plaid/sync
- DELETE api/v1/plaid/{connection}

Run `php artisan route:list --path=api/v1/accounts` and confirm:
- GET api/v1/accounts
- PATCH api/v1/accounts/{account}/purpose

Verify PlaidService can be instantiated (config loaded correctly):
```bash
php artisan tinker --execute="app(\App\Services\PlaidService::class); echo 'PlaidService OK';"
```

Verify the link token endpoint works with sandbox credentials (requires running server):
```bash
# Register a test user and get token
RESPONSE=$(curl -s -X POST http://localhost:8099/api/auth/register \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{"name":"Plaid Test","email":"plaid-test@example.com","password":"password123","password_confirmation":"password123"}')
TOKEN=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get('token',''))")

# Create link token
curl -s -X POST http://localhost:8099/api/v1/plaid/link-token \
  -H "Authorization: Bearer $TOKEN" \
  -H "Accept: application/json" \
  | python3 -c "import sys,json; d=json.load(sys.stdin); assert 'link_token' in d, f'Missing link_token: {d}'; print('PASS: Link token created')"

# Clean up
php artisan tinker --execute="\App\Models\User::where('email','plaid-test@example.com')->first()?->delete();"
```
  </verify>
  <done>PlaidController, PlaidService, and BankAccountController verified correct. Link token endpoint returns a valid link_token from Plaid sandbox. Sync cursor persistence confirmed working via model fix. All 6 Plaid/account routes exist with correct middleware.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `php artisan migrate:status` -- all 6+ migrations show "Ran"
2. `php artisan route:list --path=api/v1` -- all Plaid and account routes visible
3. BankConnection model uses `sync_cursor` (not `plaid_cursor`)
4. `error_code` and `error_message` columns exist in bank_connections table
5. PlaidService instantiates without errors
6. Link token endpoint returns valid Plaid link_token from sandbox
</verification>

<success_criteria>
- PLAID-01: createLinkToken endpoint returns link_token from Plaid sandbox
- PLAID-02: exchangeToken endpoint exists and calls PlaidService::exchangePublicToken
- PLAID-03: syncTransactions uses cursor-based sync and persists cursor correctly
- PLAID-04: Bank account index endpoint returns accounts with balances via BankAccountResource
- PLAID-05: Disconnect endpoint calls PlaidService::disconnect (revokes token + deletes)
- PLAID-06: updatePurpose endpoint accepts personal/business/mixed/investment
- PLAID-07: Account purpose cascades to transactions (bulk update on purpose change)
- PLAID-08: PlaidService::getBalances fetches and updates account balances
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-bank-integration/02-02-SUMMARY.md`
</output>
