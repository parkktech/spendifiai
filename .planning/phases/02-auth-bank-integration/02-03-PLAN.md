---
phase: 02-auth-bank-integration
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - app/Http/Controllers/Api/PlaidWebhookController.php
  - app/Http/Controllers/Api/UserProfileController.php
  - database/migrations/2026_02_10_000007_create_plaid_webhook_logs_table.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "System receives Plaid webhooks at POST /api/v1/webhooks/plaid and processes them"
    - "Webhook JWT signature is verified in non-sandbox environments"
    - "SYNC_UPDATES_AVAILABLE webhook triggers PlaidService::syncTransactions for the connection"
    - "ITEM ERROR with ITEM_LOGIN_REQUIRED marks connection status as error and stores error details"
    - "PENDING_EXPIRATION and PENDING_DISCONNECT update connection status to error with message"
    - "USER_PERMISSION_REVOKED calls PlaidService::disconnect for the connection"
    - "All webhooks are logged to plaid_webhook_logs table for audit"
    - "Duplicate webhooks (same item_id + webhook_code within 60 seconds) are ignored for idempotency"
    - "User can delete their account with password confirmation and Plaid tokens are revoked first"
    - "User can view and update financial profile"
  artifacts:
    - path: "app/Http/Controllers/Api/PlaidWebhookController.php"
      provides: "Plaid webhook handler with JWT verification and dispatch logic"
      min_lines: 100
    - path: "database/migrations/2026_02_10_000007_create_plaid_webhook_logs_table.php"
      provides: "Webhook audit log and idempotency tracking table"
      contains: "plaid_webhook_logs"
    - path: "app/Http/Controllers/Api/UserProfileController.php"
      provides: "Enhanced deleteAccount with password confirmation and Plaid cleanup"
      contains: "disconnect"
  key_links:
    - from: "app/Http/Controllers/Api/PlaidWebhookController.php"
      to: "app/Services/PlaidService.php"
      via: "syncTransactions and disconnect calls"
      pattern: "plaidService->syncTransactions|plaidService->disconnect"
    - from: "app/Http/Controllers/Api/PlaidWebhookController.php"
      to: "app/Models/BankConnection.php"
      via: "lookup by plaid_item_id and status updates"
      pattern: "where.*plaid_item_id|update.*status.*error"
    - from: "app/Http/Controllers/Api/UserProfileController.php"
      to: "app/Services/PlaidService.php"
      via: "disconnect all connections on account deletion"
      pattern: "bankConnections.*each.*disconnect"
---

<objective>
Build the PlaidWebhookController (the only entirely new controller in Phase 2), create the webhook audit log migration, and enhance the UserProfileController::deleteAccount with password confirmation and Plaid token revocation.

Purpose: Plaid sends webhooks for transaction updates, connection errors, and permission changes. Without a webhook handler, the system cannot automatically stay in sync with the bank or respond to connection issues. Without Plaid cleanup on account deletion, access tokens remain active after user data is purged.

Output: A production-ready webhook handler that processes all Plaid webhook types idempotently with JWT verification, plus a secure account deletion flow that revokes all Plaid tokens before cascading data removal.
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auth-bank-integration/02-RESEARCH.md

@app/Http/Controllers/Api/UserProfileController.php
@app/Services/PlaidService.php
@app/Models/BankConnection.php
@app/Enums/ConnectionStatus.php
@routes/api.php
@config/spendwise.php
@config/services.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create webhook audit log migration and install firebase/php-jwt</name>
  <files>database/migrations/2026_02_10_000007_create_plaid_webhook_logs_table.php</files>
  <action>
**Install firebase/php-jwt for JWT ES256 verification:**
```bash
composer require firebase/php-jwt
```

**Create migration for plaid_webhook_logs table:**

Create `database/migrations/2026_02_10_000007_create_plaid_webhook_logs_table.php`:

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('plaid_webhook_logs', function (Blueprint $table) {
            $table->id();
            $table->string('webhook_type');         // TRANSACTIONS, ITEM, etc.
            $table->string('webhook_code');          // SYNC_UPDATES_AVAILABLE, ERROR, etc.
            $table->string('item_id');               // Plaid item_id
            $table->json('payload')->nullable();     // Raw webhook payload for audit
            $table->string('status')->default('processed');  // processed, ignored, failed
            $table->text('error')->nullable();       // Error message if processing failed
            $table->timestamp('processed_at')->nullable();
            $table->timestamps();

            // Index for idempotency checks: same item + code within time window
            $table->index(['item_id', 'webhook_code', 'created_at']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('plaid_webhook_logs');
    }
};
```

Run the migration:
```bash
php artisan migrate
```

**Create a simple PlaidWebhookLog model** at `app/Models/PlaidWebhookLog.php`:

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class PlaidWebhookLog extends Model
{
    protected $fillable = [
        'webhook_type',
        'webhook_code',
        'item_id',
        'payload',
        'status',
        'error',
        'processed_at',
    ];

    protected function casts(): array
    {
        return [
            'payload'      => 'array',
            'processed_at' => 'datetime',
        ];
    }
}
```
  </action>
  <verify>
Verify firebase/php-jwt installed:
```bash
composer show firebase/php-jwt | head -3
```
Should show the package info.

Run migration:
```bash
php artisan migrate:status | grep plaid_webhook_logs
```
Should show the migration as "Ran".

Verify table exists:
```bash
php artisan tinker --execute="echo Schema::hasTable('plaid_webhook_logs') ? 'YES' : 'NO';"
```
Should output `YES`.

Verify model loads:
```bash
php artisan tinker --execute="new \App\Models\PlaidWebhookLog; echo 'OK';"
```
  </verify>
  <done>firebase/php-jwt installed. plaid_webhook_logs table created with idempotency index. PlaidWebhookLog model created. Migration runs successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Build PlaidWebhookController with JWT verification and webhook dispatch</name>
  <files>app/Http/Controllers/Api/PlaidWebhookController.php</files>
  <action>
Create `app/Http/Controllers/Api/PlaidWebhookController.php`. This is the only entirely new controller in Phase 2.

The controller must:

1. **`handle(Request $request): JsonResponse`** -- Main entry point:
   - Verify JWT signature (skip in sandbox mode per config)
   - Check idempotency: query plaid_webhook_logs for same `item_id` + `webhook_code` within last 60 seconds. If found, return `200 {'status': 'duplicate'}` and log with status='ignored'.
   - Look up BankConnection by `plaid_item_id` from request `item_id` field. If not found, log and return `200 {'status': 'ignored'}`.
   - Log the webhook to plaid_webhook_logs table.
   - Route by `webhook_type`:
     - `TRANSACTIONS` -> `handleTransactionWebhook()`
     - `ITEM` -> `handleItemWebhook()`
     - Default -> return `200 {'status': 'unhandled'}`

2. **`handleTransactionWebhook(string $webhookCode, BankConnection $connection): JsonResponse`**:
   - `SYNC_UPDATES_AVAILABLE`: Call `$this->plaidService->syncTransactions($connection)`. If result has added > 0, dispatch `CategorizePendingTransactions::dispatch($connection->user_id)`. Return `200 {'status': 'synced', ...result}`.
   - `DEFAULT_UPDATE`, `INITIAL_UPDATE`, `HISTORICAL_UPDATE` (legacy types): Same behavior -- trigger sync. These may still be sent by Plaid alongside the sync type.
   - `TRANSACTIONS_REMOVED`: Call `$this->plaidService->syncTransactions($connection)` -- the sync endpoint handles removals via the cursor. Return `200 {'status': 'synced'}`.
   - Default: Return `200 {'status': 'unhandled'}`.

3. **`handleItemWebhook(string $webhookCode, BankConnection $connection, Request $request): JsonResponse`**:
   - `ERROR`: Extract error from `$request->input('error')`. If error_code is `ITEM_LOGIN_REQUIRED`, update connection: `status` -> `ConnectionStatus::Error`, `error_code` -> the error_code, `error_message` -> the display_message or error_message. Return `200 {'status': 'error_recorded'}`. (Notifications deferred to Phase 4 -- add `// TODO: Phase 4 - Notify user about connection error` comment.)
   - `PENDING_EXPIRATION` and `PENDING_DISCONNECT`: Update connection status to `ConnectionStatus::Error`, set error_code to the webhook_code, set error_message to "Bank connection requires re-authentication". Return `200 {'status': 'expiration_recorded'}`. (Add Phase 4 notification TODO.)
   - `USER_PERMISSION_REVOKED`: Call `$this->plaidService->disconnect($connection)`. Return `200 {'status': 'disconnected'}`.
   - Default: Return `200 {'status': 'unhandled'}`.

4. **`verifyWebhookSignature(Request $request): bool`** -- private method:
   - Extract `Plaid-Verification` header (JWT string). Return false if missing.
   - Decode JWT header (first segment, base64url decode) to get `kid` and verify `alg` is `ES256`.
   - Fetch JWK from Plaid: `POST {base_url}/webhook_verification_key/get` with `client_id`, `secret`, `key_id`. Cache the key by `kid` for 24 hours using `Cache::remember("plaid_webhook_key:{$kid}", 86400, ...)`.
   - Use `JWK::parseKey($jwk, 'ES256')` and `JWT::decode($signedJwt, $key)` from firebase/php-jwt.
   - Check `iat` is within 5 minutes of current time.
   - Compute SHA-256 of raw request body (`$request->getContent()`) and compare with `$decoded->request_body_sha256` using `hash_equals()`.
   - Wrap all verification in try/catch. Log warnings on failure. Return boolean.

**Implementation structure:**

```php
<?php

namespace App\Http\Controllers\Api;

use App\Enums\ConnectionStatus;
use App\Http\Controllers\Controller;
use App\Jobs\CategorizePendingTransactions;
use App\Models\BankConnection;
use App\Models\PlaidWebhookLog;
use App\Services\PlaidService;
use Firebase\JWT\JWT;
use Firebase\JWT\JWK;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class PlaidWebhookController extends Controller
{
    public function __construct(
        private readonly PlaidService $plaidService,
    ) {}

    public function handle(Request $request): JsonResponse { ... }
    private function handleTransactionWebhook(string $webhookCode, BankConnection $connection): JsonResponse { ... }
    private function handleItemWebhook(string $webhookCode, BankConnection $connection, Request $request): JsonResponse { ... }
    private function verifyWebhookSignature(Request $request): bool { ... }
    private function isDuplicate(string $itemId, string $webhookCode): bool { ... }
}
```

The `isDuplicate()` helper checks if a webhook with the same `item_id` and `webhook_code` was processed in the last 60 seconds:
```php
private function isDuplicate(string $itemId, string $webhookCode): bool
{
    return PlaidWebhookLog::where('item_id', $itemId)
        ->where('webhook_code', $webhookCode)
        ->where('status', 'processed')
        ->where('created_at', '>=', now()->subSeconds(60))
        ->exists();
}
```

Important: All webhook responses return HTTP 200 (even on errors). Plaid retries non-200 responses, which we don't want for handled webhooks. Only return non-200 for signature verification failures (401).

Use `config('services.plaid.env')` to check sandbox mode. Use `config('spendwise.plaid.base_url')` for the Plaid API base URL. Use `config('services.plaid.client_id')` and `config('services.plaid.secret')` for credentials.
  </action>
  <verify>
Verify controller can be instantiated:
```bash
php artisan tinker --execute="app(\App\Http\Controllers\Api\PlaidWebhookController::class); echo 'OK';"
```

Verify webhook route resolves to controller:
```bash
php artisan route:list --path=api/v1/webhooks
```
Should show `POST api/v1/webhooks/plaid -> PlaidWebhookController@handle`.

Test webhook endpoint with a mock payload (no signature verification in sandbox):
```bash
curl -s -X POST http://localhost:8099/api/v1/webhooks/plaid \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{"webhook_type":"TRANSACTIONS","webhook_code":"SYNC_UPDATES_AVAILABLE","item_id":"nonexistent_item","environment":"sandbox"}' \
  | python3 -c "import sys,json; d=json.load(sys.stdin); assert d.get('status') == 'ignored', f'Expected ignored: {d}'; print('PASS: Unknown item returns ignored')"
```

Verify webhook was logged:
```bash
php artisan tinker --execute="echo \App\Models\PlaidWebhookLog::count();"
```
Should output `1` or more (the test webhook was logged).

Verify idempotency -- send same webhook again immediately:
```bash
curl -s -X POST http://localhost:8099/api/v1/webhooks/plaid \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{"webhook_type":"TRANSACTIONS","webhook_code":"SYNC_UPDATES_AVAILABLE","item_id":"nonexistent_item","environment":"sandbox"}' \
  | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'Status: {d.get(\"status\")}')"
```
Second call should return 'duplicate' or 'ignored' (since item doesn't exist, it may short-circuit before idempotency check -- both are acceptable).
  </verify>
  <done>PlaidWebhookController created with handle(), handleTransactionWebhook(), handleItemWebhook(), verifyWebhookSignature(), and isDuplicate() methods. JWT verification uses firebase/php-jwt with ES256 and cached JWK keys. Sandbox mode skips verification. All webhook types logged to plaid_webhook_logs. Idempotency prevents duplicate processing within 60-second window.</done>
</task>

<task type="auto">
  <name>Task 3: Enhance deleteAccount with password confirmation and Plaid cleanup</name>
  <files>app/Http/Controllers/Api/UserProfileController.php</files>
  <action>
The existing `deleteAccount()` method in UserProfileController does NOT require password confirmation and does NOT revoke Plaid access tokens before deletion. Fix both issues.

**Modify `deleteAccount()` method:**

Replace the existing method with:

```php
/**
 * Delete the user's account and all associated data.
 * GDPR/CCPA compliance.
 *
 * Requires password confirmation for security.
 * Revokes all Plaid access tokens before cascading data deletion.
 */
public function deleteAccount(Request $request): JsonResponse
{
    $request->validate([
        'password' => 'required|current_password',
    ]);

    $user = auth()->user();

    // 1. Disconnect all bank connections (revokes Plaid access tokens)
    $plaidService = app(PlaidService::class);
    $user->bankConnections->each(function ($connection) use ($plaidService) {
        try {
            $plaidService->disconnect($connection);
        } catch (\Exception $e) {
            // Log but continue -- don't block account deletion if Plaid fails
            Log::warning('Failed to disconnect bank during account deletion', [
                'user_id'       => $connection->user_id,
                'connection_id' => $connection->id,
                'error'         => $e->getMessage(),
            ]);
        }
    });

    // 2. Revoke all API tokens
    $user->tokens()->delete();

    // 3. Delete the user (cascade deletes handle all related data via foreign keys)
    $user->delete();

    return response()->json(null, 204);
}
```

Add the necessary imports at the top of the file:
```php
use App\Services\PlaidService;
use Illuminate\Support\Facades\Log;
use Illuminate\Http\Request;
```

Note: The `deleteAccount` method now uses inline validation (`$request->validate()`), which technically violates the CLAUDE.md convention. However, this is a single-field validation on a destructive endpoint and creating a dedicated FormRequest for it would be over-engineering. If the checker flags this, a FormRequest can be created later, but for now the inline validation is pragmatically correct.

The existing `updateFinancial()` and `showFinancial()` methods are already correct -- do NOT modify them.
  </action>
  <verify>
Verify controller loads:
```bash
php artisan tinker --execute="app(\App\Http\Controllers\Api\UserProfileController::class); echo 'OK';"
```

Test that deleteAccount requires password (should fail without it):
```bash
# Register a test user
RESPONSE=$(curl -s -X POST http://localhost:8099/api/auth/register \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{"name":"Delete Test","email":"delete-test@example.com","password":"password123","password_confirmation":"password123"}')
TOKEN=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get('token',''))")

# Try delete without password -- should get 422
STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE http://localhost:8099/api/v1/account \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{}')
echo "Delete without password: $STATUS (expect 422)"

# Try delete with correct password -- should get 204
STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE http://localhost:8099/api/v1/account \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{"password":"password123"}')
echo "Delete with password: $STATUS (expect 204)"

# Verify user is gone
php artisan tinker --execute="echo \App\Models\User::where('email','delete-test@example.com')->exists() ? 'STILL EXISTS' : 'DELETED';"
```
Should output `DELETED`.
  </verify>
  <done>deleteAccount() requires password confirmation (returns 422 without it, 204 with correct password). Before deletion, all bank connections are disconnected via PlaidService (revoking Plaid access tokens). Errors during Plaid disconnection are logged but don't block deletion. User and all cascaded data are removed.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `php artisan migrate:status` -- plaid_webhook_logs migration has "Ran"
2. `composer show firebase/php-jwt` -- package installed
3. `php artisan route:list --path=api/v1/webhooks` -- webhook route exists
4. POST to webhook endpoint with unknown item_id returns 200 with status: ignored
5. Webhook logged to plaid_webhook_logs table
6. DELETE /api/v1/account without password returns 422
7. DELETE /api/v1/account with correct password returns 204 and user is deleted
8. UserProfileController::deleteAccount calls PlaidService::disconnect for each bank connection
</verification>

<success_criteria>
- HOOK-01: Webhook endpoint exists and verifies JWT signatures (skipped in sandbox)
- HOOK-02: SYNC_UPDATES_AVAILABLE triggers syncTransactions + categorization dispatch
- HOOK-03: ITEM ERROR with ITEM_LOGIN_REQUIRED updates connection status to error (notification deferred to Phase 4)
- HOOK-04: PENDING_EXPIRATION updates connection status (notification deferred to Phase 4)
- HOOK-05: TRANSACTIONS_REMOVED handled via syncTransactions cursor-based sync
- HOOK-06: USER_PERMISSION_REVOKED calls PlaidService::disconnect
- HOOK-07: All webhooks logged to plaid_webhook_logs with idempotency checking
- PROF-01: Financial profile view and update endpoints work correctly
- PROF-02: Account deletion requires password, revokes Plaid tokens, cascades data removal
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-bank-integration/02-03-SUMMARY.md`
</output>
