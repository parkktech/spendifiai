---
phase: 01-scaffolding-api-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - composer.json
  - package.json
  - .env
  - .env.example
  - app/Models/User.php
  - app/Models/SavingsTarget.php
  - app/Models/Subscription.php
  - app/Models/SavingsProgress.php
  - app/Models/AIQuestion.php
  - app/Models/BankAccount.php
  - app/Models/BankConnection.php
  - app/Models/BudgetGoal.php
  - app/Models/EmailConnection.php
  - app/Models/ExpenseCategory.php
  - app/Models/Order.php
  - app/Models/OrderItem.php
  - app/Models/ParsedEmail.php
  - app/Models/SavingsPlanAction.php
  - app/Models/SavingsRecommendation.php
  - app/Models/Transaction.php
  - app/Models/UserFinancialProfile.php
  - app/Enums/AccountPurpose.php
  - app/Enums/ConnectionStatus.php
  - app/Enums/ExpenseType.php
  - app/Enums/QuestionStatus.php
  - app/Enums/QuestionType.php
  - app/Enums/ReviewStatus.php
  - app/Enums/SubscriptionStatus.php
  - app/Http/Controllers/Auth/AuthController.php
  - app/Http/Controllers/Auth/EmailVerificationController.php
  - app/Http/Controllers/Auth/PasswordResetController.php
  - app/Http/Controllers/Auth/SocialAuthController.php
  - app/Http/Controllers/Auth/TwoFactorController.php
  - app/Http/Controllers/Api/SpendWiseController.php
  - app/Http/Middleware/Enforce2FA.php
  - app/Http/Middleware/EnsureBankConnected.php
  - app/Http/Middleware/EnsureProfileComplete.php
  - app/Http/Middleware/VerifyCaptcha.php
  - app/Http/Requests/Auth/LoginRequest.php
  - app/Http/Requests/Auth/RegisterRequest.php
  - app/Jobs/CategorizePendingTransactions.php
  - app/Mail/TaxPackageMail.php
  - app/Policies/AIQuestionPolicy.php
  - app/Policies/BankAccountPolicy.php
  - app/Policies/SubscriptionPolicy.php
  - app/Policies/TransactionPolicy.php
  - app/Providers/AppServiceProvider.php
  - app/Providers/FortifyServiceProvider.php
  - app/Actions/Fortify/CreateNewUser.php
  - app/Actions/Fortify/ResetUserPassword.php
  - app/Actions/Fortify/UpdateUserPassword.php
  - app/Services/PlaidService.php
  - app/Services/CaptchaService.php
  - app/Services/SubscriptionDetectorService.php
  - app/Services/TaxExportService.php
  - app/Services/AI/TransactionCategorizerService.php
  - app/Services/AI/SavingsAnalyzerService.php
  - app/Services/AI/SavingsTargetPlannerService.php
  - bootstrap/app.php
  - config/spendwise.php
  - config/services.php
  - config/fortify.php
  - database/migrations/2026_02_10_000001_create_spendwise_tables.php
  - database/migrations/2026_02_10_000002_add_account_purpose.php
  - database/migrations/2026_02_10_000003_create_savings_targets.php
  - database/migrations/2026_02_10_000004_add_auth_columns.php
  - database/migrations/2026_02_10_000005_encrypt_sensitive_columns.php
  - database/seeders/ExpenseCategorySeeder.php
  - routes/api.php
  - routes/web.php
  - routes/console.php
  - resources/scripts/generate_tax_excel.py
  - resources/scripts/generate_tax_pdf.py
  - resources/views/emails/tax-package.blade.php
autonomous: true
must_haves:
  truths:
    - "Running php artisan serve starts the application without errors"
    - "Running php artisan migrate creates all 14+ database tables successfully"
    - "Running php artisan db:seed --class=ExpenseCategorySeeder populates 50+ expense categories"
    - "All 16 models plus the new SavingsProgress model load without class-not-found errors"
    - "npm run build compiles frontend assets without errors"
  artifacts:
    - path: "composer.json"
      provides: "All PHP dependencies including Sanctum, Socialite, 2FA, IMAP, Plaid"
      contains: "laravel/sanctum"
    - path: "app/Models/SavingsProgress.php"
      provides: "Missing SavingsProgress model referenced by SpendWiseController and SavingsTargetPlannerService"
      min_lines: 20
    - path: "app/Models/SavingsTarget.php"
      provides: "SavingsTarget model with corrected $fillable matching migration columns"
      contains: "monthly_target"
    - path: "app/Models/Subscription.php"
      provides: "Subscription model with corrected column names matching migration"
      contains: "last_charge_date"
    - path: "database/seeders/ExpenseCategorySeeder.php"
      provides: "50+ IRS-mapped expense categories"
      min_lines: 50
    - path: "bootstrap/app.php"
      provides: "Laravel 12 app config with Inertia middleware, CSRF exceptions, statefulApi"
    - path: ".env"
      provides: "Database, Redis, Plaid sandbox credentials configured"
      contains: "DB_CONNECTION=pgsql"
  key_links:
    - from: "app/Models/User.php"
      to: "database/migrations/*_create_users_table.php"
      via: "Model traits and fillable matching migration columns"
      pattern: "HasApiTokens.*HasFactory.*Notifiable.*TwoFactorAuthenticatable"
    - from: "app/Providers/AppServiceProvider.php"
      to: "app/Policies/*.php"
      via: "Gate::policy registrations"
      pattern: "Gate::policy"
    - from: "bootstrap/app.php"
      to: "routes/api.php"
      via: "withRouting api directive"
      pattern: "api:.*routes/api.php"
---

<objective>
Create a fresh Laravel 12 project with the React starter kit, integrate all existing backend code from existing-code/, fix known model-migration mismatches, create the missing SavingsProgress model, configure the database, and verify the application boots and migrates cleanly.

Purpose: Establish the foundation -- a running Laravel 12 app with all 16+ models, 7 services, 5 auth controllers, 7 enums, 4 middleware, 4 policies, 5 migrations, and seeders properly integrated. Nothing else can be built until this foundation works.

Output: A bootable Laravel 12 application at /var/www/html/spendifiai with all existing code integrated and database migrated.
</objective>

<execution_context>
@/home/jratz/.claude/get-shit-done/workflows/execute-plan.md
@/home/jratz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-scaffolding-api-architecture/01-RESEARCH.md
@existing-code/composer.json
@existing-code/app/Models/User.php
@existing-code/app/Models/SavingsTarget.php
@existing-code/app/Models/Subscription.php
@existing-code/app/Providers/AppServiceProvider.php
@existing-code/bootstrap/app.php
@existing-code/routes/api.php
@existing-code/routes/web.php
@existing-code/routes/console.php
@existing-code/database/migrations/2026_02_10_000001_create_spendwise_tables.php
@existing-code/database/migrations/2026_02_10_000003_create_savings_targets.php
@existing-code/database/migrations/2026_02_10_000004_add_auth_columns.php
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Laravel 12 project and install all dependencies</name>
  <files>
    composer.json
    package.json
    .env
    .env.example
  </files>
  <action>
**Step 1: Prepare the working directory.**
The current directory /var/www/html/spendifiai has planning files and existing-code/. We need to create a Laravel project HERE (not in a subdirectory). The approach:
1. Back up the existing planning artifacts: `cp -r .planning /tmp/spendifiai-planning && cp -r existing-code /tmp/spendifiai-existing && cp CLAUDE.md /tmp/spendifiai-claude.md && cp -r docs /tmp/spendifiai-docs 2>/dev/null; cp TASKS.md /tmp/spendifiai-tasks.md 2>/dev/null`
2. Create the Laravel project in a temp location: `composer create-project laravel/laravel /tmp/spendifiai-fresh --prefer-dist`
3. Copy the fresh Laravel project files into /var/www/html/spendifiai (without overwriting .git, .planning, existing-code, CLAUDE.md, docs): Use rsync or careful cp to bring in the Laravel scaffold.
4. Restore planning artifacts: copy back .planning, CLAUDE.md, docs, TASKS.md, existing-code

**Step 2: Install the React starter kit.**
Per Laravel 12 docs, install the React starter kit package:
```bash
cd /var/www/html/spendifiai
php artisan install:starter-kit react
```
This will scaffold Inertia 2 + React 19 + TypeScript + shadcn/ui + Tailwind 4 + Vite + auth pages.
If prompted, select defaults (Pest for testing framework, dark mode support).

**Step 3: Install additional PHP dependencies.**
```bash
composer require laravel/sanctum laravel/socialite pragmarx/google2fa-laravel bacon/bacon-qr-code webklex/laravel-imap google/apiclient predis/predis guzzlehttp/guzzle
```
Sanctum is critical -- the existing code uses HasApiTokens. The starter kit uses session auth via Fortify, but API routes need bearer token auth.

After installing Sanctum, publish its migration if not already present:
```bash
php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider"
```

**Step 4: Install frontend dependencies.**
```bash
npm install
```

**Step 5: Configure .env.**
Copy .env from existing-code/ as the base (it has Plaid sandbox creds). Then update:
- `APP_KEY` -- generate with `php artisan key:generate`
- `DB_CONNECTION=pgsql`
- `DB_HOST=127.0.0.1`
- `DB_PORT=5432`
- `DB_DATABASE=spendifiai_dev`
- `DB_USERNAME=root`
- `DB_PASSWORD=soyou812`
- `CACHE_STORE=redis`
- `SESSION_DRIVER=redis`
- `QUEUE_CONNECTION=redis`
- `REDIS_HOST=127.0.0.1`

Also update .env.example from existing-code to include all the same keys with placeholder values.

**IMPORTANT:** Do NOT install `laravel/breeze` -- that's the old approach. The React starter kit is the correct Laravel 12 method.
  </action>
  <verify>
1. `php artisan --version` outputs Laravel 12.x
2. `composer show laravel/sanctum` shows version 4.x
3. `composer show laravel/socialite` shows version 5.x
4. `npm ls react` shows React 19.x
5. `npm run build` completes without errors
6. `php artisan env` (or check .env) shows DB_CONNECTION=pgsql
  </verify>
  <done>
Laravel 12 project exists at /var/www/html/spendifiai with React starter kit installed, all PHP and JS dependencies resolved, .env configured for PostgreSQL + Redis, and frontend assets build successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate all existing code, fix model mismatches, and verify migrations</name>
  <files>
    app/Models/SavingsProgress.php
    app/Models/SavingsTarget.php
    app/Models/Subscription.php
    app/Models/User.php
    app/Providers/AppServiceProvider.php
    bootstrap/app.php
    routes/api.php
    routes/web.php
    routes/console.php
    database/migrations/2026_02_10_000001_create_spendwise_tables.php
    database/migrations/2026_02_10_000002_add_account_purpose.php
    database/migrations/2026_02_10_000003_create_savings_targets.php
    database/migrations/2026_02_10_000004_add_auth_columns.php
    database/migrations/2026_02_10_000005_encrypt_sensitive_columns.php
    database/seeders/ExpenseCategorySeeder.php
    config/spendwise.php
    config/services.php
    config/fortify.php
  </files>
  <action>
**Step 1: Copy all existing code files, excluding Zone.Identifier files.**
Copy each directory from existing-code/ into the project, excluding *:Zone.Identifier files:

```bash
# Copy all app/ subdirectories
rsync -av --exclude='*:Zone.Identifier' existing-code/app/ app/

# Copy config files (merge, don't replace starter kit configs)
cp existing-code/config/spendwise.php config/spendwise.php
# For services.php and fortify.php: use existing versions since they have project-specific config
cp existing-code/config/services.php config/services.php
cp existing-code/config/fortify.php config/fortify.php

# Copy database files
rsync -av --exclude='*:Zone.Identifier' existing-code/database/migrations/ database/migrations/
rsync -av --exclude='*:Zone.Identifier' existing-code/database/seeders/ database/seeders/

# Copy routes (CAREFUL: merge web.php, replace api.php and console.php)
cp existing-code/routes/api.php routes/api.php
cp existing-code/routes/console.php routes/console.php

# Copy resources
rsync -av --exclude='*:Zone.Identifier' existing-code/resources/ resources/
```

For web.php: MERGE the existing web.php (Google OAuth callback, email verification, health check) with the starter kit's web.php (Inertia routes for auth pages, dashboard). The starter kit web.php has critical Inertia routes -- do NOT replace it wholesale. Instead, ADD the existing routes to the starter kit's web.php.

For bootstrap/app.php: Start from the existing version but ensure the starter kit's Inertia middleware is included. The existing version has:
- `statefulApi()` -- keep
- `trustProxies(at: '*')` -- keep
- `validateCsrfTokens(except: ['api/*', 'webhooks/*'])` -- keep
- The starter kit adds `HandleInertiaRequests` and `AddLinkHeadersForPreloadedAssets` middleware via `$middleware->web(append: [...])`. This MUST be added.

Merge bootstrap/app.php to include BOTH the existing config AND the starter kit's Inertia middleware. The result should have:
```php
->withMiddleware(function (Middleware $middleware) {
    $middleware->web(append: [
        \App\Http\Middleware\HandleInertiaRequests::class,
        \Illuminate\Http\Middleware\AddLinkHeadersForPreloadedAssets::class,
    ]);
    $middleware->statefulApi();
    $middleware->trustProxies(at: '*');
    $middleware->validateCsrfTokens(except: [
        'api/*',
        'webhooks/*',
    ]);
})
```

**Step 2: Handle User model conflict.**
The existing User model (existing-code/app/Models/User.php) has everything needed: HasApiTokens, HasFactory, Notifiable, TwoFactorAuthenticatable, MustVerifyEmail, 15 relationships, encrypted casts, $hidden. Use it AS-IS -- it's the authoritative version. The starter kit's User model is a subset. OVERWRITE the starter kit's User.php with the existing one.

**Step 3: Handle AppServiceProvider conflict.**
Use the existing AppServiceProvider (has route model bindings, middleware aliases, policy registrations). If the starter kit's AppServiceProvider has any Inertia-specific registrations, merge those in. Typically the starter kit AppServiceProvider is empty, so the existing one takes precedence.

**Step 4: Handle migration ordering.**
The starter kit creates these migrations:
- `0001_01_01_000000_create_users_table.php` (users, password_resets, sessions)
- `0001_01_01_000001_create_cache_table.php` (cache, cache_locks)
- `0001_01_01_000002_create_jobs_table.php` (jobs, job_batches, failed_jobs)

The existing migration 000004 (`add_auth_columns`) adds columns to users table. It already has `if (!Schema::hasColumn(...))` guards for 2FA columns, so it's safe.

IMPORTANT: The starter kit may also ship an `add_two_factor_columns_to_users_table` migration (from Fortify). Check if it exists. If so, the existing migration 000004's guard `if (!Schema::hasColumn('users', 'two_factor_secret'))` will prevent duplication. Leave both -- the guard handles it.

Keep ALL migrations. The ordering (starter kit 0001* runs first, then existing 2026* runs after) is correct by timestamp.

**Step 5: Fix SavingsTarget model -- $fillable mismatch with migration.**
The migration creates columns: `monthly_target, motivation, target_start_date, target_end_date, goal_total, is_active`.
The model currently lists: `user_id, goal_name, target_amount, monthly_target, current_savings, deadline, status`.
The SpendWiseController creates records with: `monthly_target, motivation, goal_total, target_start_date, is_active`.

UPDATE SavingsTarget model $fillable to match migration:
```php
protected $fillable = [
    'user_id', 'monthly_target', 'motivation', 'target_start_date',
    'target_end_date', 'goal_total', 'is_active',
];
```

Also update casts to match:
```php
protected function casts(): array
{
    return [
        'monthly_target'    => 'decimal:2',
        'goal_total'        => 'decimal:2',
        'target_start_date' => 'date',
        'target_end_date'   => 'date',
        'is_active'         => 'boolean',
    ];
}
```

**Step 6: Fix Subscription model -- column name mismatch.**
Migration columns: `last_charge_date` (date), `next_expected_date` (date).
Model currently has: `last_charged_at` (datetime cast), `next_charge_at` (datetime cast).

UPDATE Subscription model $fillable and casts:
- Replace `last_charged_at` with `last_charge_date` in $fillable
- Replace `next_charge_at` with `next_expected_date` in $fillable
- Change casts: `last_charge_date` => `'date'`, `next_expected_date` => `'date'` (they're DATE columns, not timestamps)

**Step 7: Create the missing SavingsProgress model.**
File: `app/Models/SavingsProgress.php`

Based on migration 000003 `savings_progress` table and usage in SpendWiseController (line 568) and SavingsTargetPlannerService:

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class SavingsProgress extends Model
{
    protected $table = 'savings_progress';

    protected $fillable = [
        'user_id', 'savings_target_id', 'month',
        'income', 'total_spending', 'actual_savings', 'target_savings',
        'gap', 'cumulative_saved', 'cumulative_target',
        'target_met', 'category_breakdown', 'plan_adherence',
    ];

    protected function casts(): array
    {
        return [
            'income'             => 'decimal:2',
            'total_spending'     => 'decimal:2',
            'actual_savings'     => 'decimal:2',
            'target_savings'     => 'decimal:2',
            'gap'                => 'decimal:2',
            'cumulative_saved'   => 'decimal:2',
            'cumulative_target'  => 'decimal:2',
            'target_met'         => 'boolean',
            'category_breakdown' => 'array',
            'plan_adherence'     => 'array',
        ];
    }

    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }

    public function savingsTarget(): BelongsTo
    {
        return $this->belongsTo(SavingsTarget::class);
    }
}
```

**Step 8: Add SavingsProgress relationship to User model.**
Add to User model:
```php
public function savingsProgress(): HasMany
{
    return $this->hasMany(SavingsProgress::class);
}
```

**Step 9: Add SavingsProgress relationship to SavingsTarget model.**
Add to SavingsTarget model:
```php
public function progress(): HasMany
{
    return $this->hasMany(SavingsProgress::class);
}
```
(Requires adding `use Illuminate\Database\Eloquent\Relations\HasMany;` import if not present.)

**Step 10: Ensure the database exists and run migrations + seed.**
```bash
# Create database if it doesn't exist
PGPASSWORD=soyou812 psql -U root -h 127.0.0.1 -c "CREATE DATABASE spendifiai_dev;" 2>/dev/null || true

php artisan migrate
php artisan db:seed --class=ExpenseCategorySeeder
```

**Step 11: Delete Zone.Identifier files if any slipped through.**
```bash
find /var/www/html/spendifiai/app -name "*:Zone.Identifier" -delete
find /var/www/html/spendifiai/database -name "*:Zone.Identifier" -delete
find /var/www/html/spendifiai/config -name "*:Zone.Identifier" -delete
find /var/www/html/spendifiai/routes -name "*:Zone.Identifier" -delete
find /var/www/html/spendifiai/resources -name "*:Zone.Identifier" -delete
```

**Step 12: Verify no missing classes.**
```bash
php artisan route:list --path=api 2>&1 | head -5
```
This will fail with "Target class does not exist" for the 10 API controllers that don't exist yet (they're created in Plan 02). That's EXPECTED. But auth routes should resolve fine since the 5 auth controllers were copied.

Instead, verify the app boots:
```bash
php artisan about
```
  </action>
  <verify>
1. `php artisan migrate:status` shows all migrations ran successfully (including starter kit's users/cache/jobs + existing 5 migrations)
2. `php artisan tinker --execute="echo App\Models\ExpenseCategory::count();"` outputs 50+ (seeder worked)
3. `php artisan tinker --execute="echo class_exists('App\Models\SavingsProgress') ? 'yes' : 'no';"` outputs "yes"
4. `php artisan tinker --execute="echo (new App\Models\SavingsTarget)->getFillable();"` includes 'motivation', 'goal_total', 'is_active' (not 'goal_name', 'target_amount')
5. `php artisan tinker --execute="echo (new App\Models\Subscription)->getFillable();"` includes 'last_charge_date', 'next_expected_date' (not 'last_charged_at', 'next_charge_at')
6. `php artisan about` runs without fatal errors
7. `npm run build` still succeeds after all file changes
8. No Zone.Identifier files exist: `find /var/www/html/spendifiai/app -name "*:Zone*" | wc -l` outputs 0
  </verify>
  <done>
All existing code is integrated into the Laravel 12 project. All 17 models load (16 existing + 1 new SavingsProgress). Model $fillable arrays match migration columns. Database has all 14+ tables created. 50+ expense categories seeded. Application boots without errors. Frontend builds successfully.
  </done>
</task>

</tasks>

<verification>
1. `php artisan serve` starts without errors (test with `curl -s http://localhost:8000 | head -20` -- should return HTML)
2. `php artisan migrate:status` shows all migrations have "Ran" status
3. `php artisan tinker --execute="echo App\Models\ExpenseCategory::count();"` returns 50+
4. `php artisan tinker --execute="$models = ['User','BankConnection','BankAccount','Transaction','Subscription','AIQuestion','EmailConnection','ParsedEmail','Order','OrderItem','ExpenseCategory','SavingsRecommendation','SavingsTarget','SavingsPlanAction','BudgetGoal','UserFinancialProfile','SavingsProgress']; foreach(\$models as \$m) { class_exists('App\\Models\\\\'.\$m) || throw new Exception(\$m.' missing'); } echo 'All 17 models loaded';"` outputs success
5. `npm run build` exits 0
</verification>

<success_criteria>
- Laravel 12 application boots at /var/www/html/spendifiai
- All 17 Eloquent models resolve without ClassNotFoundException
- PostgreSQL database has all 14+ tables from migrations
- 50+ expense categories populated by seeder
- Frontend assets compile (npm run build succeeds)
- .env configured with correct DB, Redis, and Plaid sandbox credentials
- No Zone.Identifier files in the project
</success_criteria>

<output>
After completion, create `.planning/phases/01-scaffolding-api-architecture/01-01-SUMMARY.md`
</output>
